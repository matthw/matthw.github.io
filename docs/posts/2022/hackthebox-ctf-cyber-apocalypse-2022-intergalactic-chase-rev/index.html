<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="HackTheBox CTF Cyber Apocalypse 2022: Intergalactic Chase (Reverse)">
<meta itemprop="description" content="Hack The Box was hosting a CTF event and we played together with some friends.
Here are some writeups for some of the reversing challenges i solved.
There&rsquo;s often shortcuts taken and (un)educated guesses involved, some ugly Z3 and angr for additionnal fun&hellip;
0. TOC Without A Trace (413 solves)
Teleport (307 solves)
Rebuilding (463 solves)
Nuts and Bolts (60 solves)
Shuffleme (28 solves)
Snake Code (281 solves)
Freaky Forum Interception (32 solves)"><meta itemprop="datePublished" content="2022-05-21T21:15:40+02:00" />
<meta itemprop="dateModified" content="2022-05-21T21:15:40+02:00" />
<meta itemprop="wordCount" content="5876">
<meta itemprop="keywords" content="ctf," /><meta property="og:title" content="HackTheBox CTF Cyber Apocalypse 2022: Intergalactic Chase (Reverse)" />
<meta property="og:description" content="Hack The Box was hosting a CTF event and we played together with some friends.
Here are some writeups for some of the reversing challenges i solved.
There&rsquo;s often shortcuts taken and (un)educated guesses involved, some ugly Z3 and angr for additionnal fun&hellip;
0. TOC Without A Trace (413 solves)
Teleport (307 solves)
Rebuilding (463 solves)
Nuts and Bolts (60 solves)
Shuffleme (28 solves)
Snake Code (281 solves)
Freaky Forum Interception (32 solves)" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://matth.dmz42.org/posts/2022/hackthebox-ctf-cyber-apocalypse-2022-intergalactic-chase-rev/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-21T21:15:40+02:00" />
<meta property="article:modified_time" content="2022-05-21T21:15:40+02:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="HackTheBox CTF Cyber Apocalypse 2022: Intergalactic Chase (Reverse)"/>
<meta name="twitter:description" content="Hack The Box was hosting a CTF event and we played together with some friends.
Here are some writeups for some of the reversing challenges i solved.
There&rsquo;s often shortcuts taken and (un)educated guesses involved, some ugly Z3 and angr for additionnal fun&hellip;
0. TOC Without A Trace (413 solves)
Teleport (307 solves)
Rebuilding (463 solves)
Nuts and Bolts (60 solves)
Shuffleme (28 solves)
Snake Code (281 solves)
Freaky Forum Interception (32 solves)"/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>HackTheBox CTF Cyber Apocalypse 2022: Intergalactic Chase (Reverse)</title>
	<link rel="stylesheet" href="https://matth.dmz42.org/css/style.min.037b6ee8f8c1baab6a3d0a9da11c3ff18a7552471f16c59fd98538d5ce99208b.css" integrity="sha256-A3tu6PjBuqtqPQqdoRw/8Yp1UkcfFsWf2YU41c6ZIIs=" crossorigin="anonymous">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://matth.dmz42.org"># matth.dmz42.org</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://matth.dmz42.org/posts/">Posts</a>
				<a href="https://matth.dmz42.org/tags/">Tags</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="toc-btn" class="hdr-btn desktop-only-ib" title="Table of Contents"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3" y2="6"></line><line x1="3" y1="12" x2="3" y2="12"></line><line x1="3" y1="18" x2="3" y2="18"></line></svg></button><span class="hdr-social hide-in-mobile"><a href="https://twitter.com/matth_walter" target="_blank" rel="noopener me" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://github.com/matthw" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a><a href="https://www.linkedin.com/in/mwalter/" target="_blank" rel="noopener me" title="Linkedin"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://matth.dmz42.org/posts/">Posts</a></li>
			<li><a href="https://matth.dmz42.org/tags/">Tags</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>May 21, 2022</span></div>
				<h1>HackTheBox CTF Cyber Apocalypse 2022: Intergalactic Chase (Reverse)</h1>
			</header>
			<div class="content">
				<p><a href="https://www.hackthebox.com">Hack The Box</a> was hosting a CTF event and we played together with some friends.</p>
<p>Here are some writeups for some of the reversing challenges i solved.</p>
<p>There&rsquo;s often shortcuts taken and (un)educated guesses involved, some ugly Z3 and angr for additionnal fun&hellip;</p>
<h1 id="0-toc">0. TOC<a href="#0-toc" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h1>
<ol>
<li>
<p><a href="#1-without-a-trace">Without A Trace</a> (413 solves)</p>
</li>
<li>
<p><a href="#2-teleport">Teleport</a> (307 solves)</p>
</li>
<li>
<p><a href="#3-rebuilding">Rebuilding</a> (463 solves)</p>
</li>
<li>
<p><a href="#4-nuts-and-bolts">Nuts and Bolts</a> (60 solves)</p>
</li>
<li>
<p><a href="#5-shuffleme">Shuffleme</a> (28 solves)</p>
</li>
<li>
<p><a href="#6-snake-code">Snake Code</a> (281 solves)</p>
</li>
<li>
<p><a href="#7-freaky-forum-interception">Freaky Forum Interception</a> (32 solves)</p>
</li>
<li>
<p><a href="#8-indefinite">Indefinite</a> (58 solves)</p>
</li>
</ol>
<h1 id="1-without-a-trace">1. Without A Trace<a href="#1-without-a-trace" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h1>
<p>Original file <a href="rev_without_a_trace.zip">here</a>.</p>
<p>The <code>check_password</code> function calls <code>ptrace(PTRACE_ME)</code> and uses the return value as part of the flag decryption loop.</p>
<p>It&rsquo;s a classic antidebug trick, as if the process is already being debugged, the ptrace call will fail (a process can only be traced once) and the decrypted result will be garbage.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="n">ulong</span> <span class="nf">check_password</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">param_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">ptrace_result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">undefined4</span> <span class="n">extraout_var</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">uint</span> <span class="n">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">undefined8</span> <span class="n">stack_string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">undefined8</span> <span class="n">local_30</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">undefined8</span> <span class="n">local_28</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">undefined2</span> <span class="n">local_20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">undefined</span> <span class="n">local_1e</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">local_10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">ptrace_result</span> <span class="o">=</span> <span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_TRACEME</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">stack_string</span> <span class="o">=</span> <span class="mh">0x1c4b0d0b043d2b37</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_30</span> <span class="o">=</span> <span class="mh">0x200f0a204c12204c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_28</span> <span class="o">=</span> <span class="mh">0x184f18200a204b1d</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_20</span> <span class="o">=</span> <span class="mh">0x24f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_1e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mh">0x1a</span><span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">stack_string</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">             <span class="o">*</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">stack_string</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">n</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">ptrace_result</span> <span class="o">+</span> <span class="mh">0x7fU</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* strcmp */</span>
</span></span><span class="line"><span class="cl">    <span class="n">iVar1</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">param_1</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">stack_string</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">CONCAT44</span><span class="p">(</span><span class="n">extraout_var</span><span class="p">,</span><span class="n">iVar1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffffffffff00</span> <span class="o">|</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)(</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>One way of going around that is to manipulate the <code>ptrace</code> return value to simulate a sucessful call.</p>
<p>We can just break at <code>strcmp</code>afterwards and dump the string&hellip;</p>
<pre tabindex="0"><code>% gdb ./without_a_trace
pwndbg: loaded 198 commands. Type pwndbg [filter] for a list.
pwndbg: created $rebase, $ida gdb functions (can be used with print/break)
Reading symbols from ./without_a_trace...
(No debugging symbols found in ./without_a_trace)
pwndbg&gt; break ptrace
Breakpoint 1 at 0x730
pwndbg&gt; run
Starting program: ./without_a_trace
[+] Primary Mothership Tracking Panel
[X] Unusual activity detected
 |-------] Unrecognised login location: Earth
[X] Please verify your identity by entering your password &gt; dsdsdsdsdsds

Breakpoint 1, ptrace (request=PTRACE_TRACEME) at ../sysdeps/unix/sysv/linux/ptrace.c:30

pwndbg&gt; finish
pwndbg&gt; set $rax=0
pwndbg&gt; break strcmp
Breakpoint 2 at 0x7ffff7f282a0: file ../sysdeps/x86_64/multiarch/strcmp-avx2.S, line 106.
pwndbg&gt; c
Continuing.
pwndbg&gt; x/s $rsi
0x7fffffffe340:	&#34;HTB{tr4c3_m3_up_b4_u_g0g0}&#34;
</code></pre><h1 id="2-teleport">2. Teleport<a href="#2-teleport" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h1>
<p>Original files <a href="rev_teleport.zip">here</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="n">undefined8</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span><span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">undefined8</span> <span class="n">uVar2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">uint</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">strncpy</span><span class="p">(</span><span class="n">INPUT</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x2b</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">code</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">PTR_FUN_00303020</span><span class="p">)[(</span><span class="kt">int</span><span class="p">)</span><span class="n">i</span><span class="p">])();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">iVar1</span> <span class="o">=</span> <span class="n">_setjmp</span><span class="p">((</span><span class="n">__jmp_buf_tag</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">DAT_003031a0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Looks good to me!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">!=</span> <span class="mh">0x65</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* WARNING: Subroutine does not return */</span>
</span></span><span class="line"><span class="cl">                <span class="n">longjmp</span><span class="p">((</span><span class="n">__jmp_buf_tag</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">DAT_00303300</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">iVar1</span> <span class="o">*</span> <span class="mi">200</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Something</span><span class="se">\&#39;</span><span class="s">s wrong...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">uVar2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Missing password&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">uVar2</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">uVar2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>we want to reach the <code>Looks good to me</code>, just throw it angr and reuse some old script&hellip;</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">angr</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">claripy</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># by default, angr will set PIE binary base at 0x400000</span>
</span></span><span class="line"><span class="cl"><span class="n">BASE_ADDR</span> <span class="o">=</span> <span class="mh">0x400000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rebase</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">BASE_ADDR</span> <span class="o">+</span> <span class="n">addr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="n">angr</span><span class="o">.</span><span class="n">Project</span><span class="p">(</span><span class="s1">&#39;teleport&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 64 bytes argv[1]</span>
</span></span><span class="line"><span class="cl">    <span class="n">argv1</span> <span class="o">=</span> <span class="n">claripy</span><span class="o">.</span><span class="n">BVS</span><span class="p">(</span><span class="s2">&#34;argv1&#34;</span><span class="p">,</span> <span class="mi">8</span><span class="o">*</span><span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">initial_state</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">entry_state</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;./teleport&#34;</span><span class="p">,</span> <span class="n">argv1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">sm</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">simulation_manager</span><span class="p">(</span><span class="n">initial_state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 0x1732 = good boy</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#  00101732 48 8d 3d ec 00 00 00     LEA                  argc,[s_Looks_good_to_me!_00101825]</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#  00101739 e8 a2 f2 ff ff           CALL                 &lt;EXTERNAL&gt;::puts</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 0x1740 = nop</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#  00101740 48 8d 3d f0 00 00 00     LEA                  argc,[s_Something&#39;s_wrong..._00101837]</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#  00101747 e8 94 f2 ff ff           CALL                 &lt;EXTERNAL&gt;::puts</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">sm</span><span class="o">.</span><span class="n">explore</span><span class="p">(</span><span class="n">find</span><span class="o">=</span><span class="n">rebase</span><span class="p">(</span><span class="mh">0x1732</span><span class="p">),</span> <span class="n">avoid</span><span class="o">=</span><span class="n">rebase</span><span class="p">(</span><span class="mh">0x1740</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">found</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;no solution&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">found</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">found</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">solution</span> <span class="o">=</span> <span class="n">found</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">argv1</span><span class="p">,</span> <span class="n">cast_to</span><span class="o">=</span><span class="nb">bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">solution</span> <span class="o">=</span> <span class="n">solution</span><span class="p">[:</span><span class="n">solution</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">solution</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">([</span><span class="n">main</span><span class="p">()])</span>
</span></span></code></pre></div><pre tabindex="0"><code>% python solve02.py
WARNING | 2022-05-21 10:11:38,350 | cle.loader | The main binary is a position-independent executable. It is being loaded with a base address of 0x400000.
WARNING | 2022-05-21 10:11:39,063 | angr.storage.memory_mixins.default_filler_mixin | The program is accessing memory with an unspecified value. This could indicate unwanted behavior.
WARNING | 2022-05-21 10:11:39,064 | angr.storage.memory_mixins.default_filler_mixin | angr will cope with this by generating an unconstrained symbolic variable and continuing. You can resolve this by:
WARNING | 2022-05-21 10:11:39,064 | angr.storage.memory_mixins.default_filler_mixin | 1) setting a value to the initial state
WARNING | 2022-05-21 10:11:39,064 | angr.storage.memory_mixins.default_filler_mixin | 2) adding the state option ZERO_FILL_UNCONSTRAINED_{MEMORY,REGISTERS}, to make unknown regions hold null
WARNING | 2022-05-21 10:11:39,064 | angr.storage.memory_mixins.default_filler_mixin | 3) adding the state option SYMBOL_FILL_UNCONSTRAINED_{MEMORY,REGISTERS}, to suppress these messages.
WARNING | 2022-05-21 10:11:39,064 | angr.storage.memory_mixins.default_filler_mixin | Filling memory at 0x7fffffffffeff4c with 4 unconstrained bytes referenced from 0x400a25 (PLT.__cxa_finalize+0x15 in teleport (0xa25))
WARNING | 2022-05-21 10:11:39,147 | angr.storage.memory_mixins.default_filler_mixin | Filling memory at 0x7ffffffffff0000 with 28 unconstrained bytes referenced from 0x78a620 (strncpy+0x0 in libc.so.6 (0x8a620))
[b&#39;HTB{h0pp1ng_thru_th3_sp4c3_t1m3_c0nt1nuum!}\x80\x80&#39;]
</code></pre><p>not much reversing needed&hellip;</p>
<h1 id="3-rebuilding">3. Rebuilding<a href="#3-rebuilding" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h1>
<p>Original files <a href="rev_rebuilding.zip">here</a>.</p>
<p>same as <code>Teleport</code>, just fix the <em>find</em> and <em>avoid</em> offsets&hellip;</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/python</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">angr</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">claripy</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">BASE_ADDR</span> <span class="o">=</span> <span class="mh">0x400000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rebase</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">BASE_ADDR</span> <span class="o">+</span> <span class="n">addr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="n">angr</span><span class="o">.</span><span class="n">Project</span><span class="p">(</span><span class="s1">&#39;rebuilding&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">argv1</span> <span class="o">=</span> <span class="n">claripy</span><span class="o">.</span><span class="n">BVS</span><span class="p">(</span><span class="s2">&#34;argv1&#34;</span><span class="p">,</span> <span class="mi">8</span><span class="o">*</span><span class="mh">0x21</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">initial_state</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">entry_state</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;./rebuilding&#34;</span><span class="p">,</span> <span class="n">argv1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">sm</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">simulation_manager</span><span class="p">(</span><span class="n">initial_state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sm</span><span class="o">.</span><span class="n">explore</span><span class="p">(</span><span class="n">find</span><span class="o">=</span><span class="n">rebase</span><span class="p">(</span><span class="mh">0x000009f2</span><span class="p">),</span> <span class="n">avoid</span><span class="o">=</span><span class="n">rebase</span><span class="p">(</span><span class="mh">0x00000a05</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">found</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;no solution&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">found</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">found</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">solution</span> <span class="o">=</span> <span class="n">found</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">argv1</span><span class="p">,</span> <span class="n">cast_to</span><span class="o">=</span><span class="nb">bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">solution</span> <span class="o">=</span> <span class="n">solution</span><span class="p">[:</span><span class="n">solution</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">solution</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">([</span><span class="n">main</span><span class="p">()])</span>
</span></span></code></pre></div><pre tabindex="0"><code>% python solve02.py
WARNING | 2022-05-21 10:20:18,366 | cle.loader | The main binary is a position-independent executable. It is being loaded with a base address of 0x400000.
WARNING | 2022-05-21 10:20:19,039 | angr.storage.memory_mixins.default_filler_mixin | The program is accessing memory with an unspecified value. This could indicate unwanted behavior.
WARNING | 2022-05-21 10:20:19,040 | angr.storage.memory_mixins.default_filler_mixin | angr will cope with this by generating an unconstrained symbolic variable and continuing. You can resolve this by:
WARNING | 2022-05-21 10:20:19,040 | angr.storage.memory_mixins.default_filler_mixin | 1) setting a value to the initial state
WARNING | 2022-05-21 10:20:19,040 | angr.storage.memory_mixins.default_filler_mixin | 2) adding the state option ZERO_FILL_UNCONSTRAINED_{MEMORY,REGISTERS}, to make unknown regions hold null
WARNING | 2022-05-21 10:20:19,040 | angr.storage.memory_mixins.default_filler_mixin | 3) adding the state option SYMBOL_FILL_UNCONSTRAINED_{MEMORY,REGISTERS}, to suppress these messages.
WARNING | 2022-05-21 10:20:19,040 | angr.storage.memory_mixins.default_filler_mixin | Filling memory at 0x7fffffffffeff6c with 4 unconstrained bytes referenced from 0x400745 (_start+0x5 in rebuilding (0x745))
WARNING | 2022-05-21 10:20:19,180 | angr.storage.memory_mixins.default_filler_mixin | Filling memory at 0x7ffffffffff0000 with 62 unconstrained bytes referenced from 0x78a410 (strlen+0x0 in libc.so.6 (0x8a410))
[b&#39;HTB{h1d1ng_1n_c0nstruct0r5_1n1t}&#39;]
</code></pre><h1 id="4-nuts-and-bolts">4. Nuts and Bolts<a href="#4-nuts-and-bolts" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h1>
<p>Original files <a href="rev_nuts_and_bolts.zip">here</a>.</p>
<p>It&rsquo;s Rust program, they are nice enough to give us the source code.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="p">{</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">Read</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">aes</span>::<span class="n">Aes256</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">aes</span>::<span class="n">cipher</span>::<span class="n">generic_array</span>::<span class="n">GenericArray</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">aes</span>::<span class="n">cipher</span>::<span class="p">{</span><span class="n">BlockEncrypt</span><span class="p">,</span><span class="w"> </span><span class="n">KeyInit</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">nuts_and_bolts</span>::<span class="n">StorageMethod</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">rand</span>::<span class="n">Rng</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">64</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">io</span>::<span class="n">stdin</span><span class="p">().</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">flag</span><span class="p">).</span><span class="n">expect</span><span class="p">(</span><span class="s">&#34;Flag not provided&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">orig_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span>::<span class="n">thread_rng</span><span class="p">().</span><span class="n">gen</span>::<span class="o">&lt;</span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]</span><span class="o">&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GenericArray</span>::<span class="n">from</span><span class="p">(</span><span class="n">orig_key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cipher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Aes256</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">flag</span><span class="p">.</span><span class="n">chunks_mut</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="n">for_each</span><span class="p">(</span><span class="o">|</span><span class="n">block</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">cipher</span><span class="p">.</span><span class="n">encrypt_block</span><span class="p">(</span><span class="n">GenericArray</span>::<span class="n">from_mut_slice</span><span class="p">(</span><span class="n">block</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StorageMethod</span>::<span class="n">plain</span><span class="p">(</span><span class="n">orig_key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StorageMethod</span>::<span class="n">plain</span><span class="p">(</span><span class="n">flag</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span>::<span class="n">thread_rng</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">10</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">rng</span><span class="p">.</span><span class="n">gen</span>::<span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">key</span><span class="p">.</span><span class="n">reverse</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">key</span><span class="p">.</span><span class="n">xor</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">rng</span><span class="p">.</span><span class="n">gen</span>::<span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">flag</span><span class="p">.</span><span class="n">reverse</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">flag</span><span class="p">.</span><span class="n">xor</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;Here&#39;s your key: {:?}!&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">bincode</span>::<span class="n">serialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">).</span><span class="n">unwrap</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;And here&#39;s your flag: {:?}!&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">bincode</span>::<span class="n">serialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flag</span><span class="p">).</span><span class="n">unwrap</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>and some output we need to reverse.</p>
<pre tabindex="0"><code>Here&#39;s your key: [2, 0, 0, 0, 2, 0, 0, 0, 2, 0, 0, 0, 1, 0, 0, 0, 2, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 2, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 101, 19, 249, 222, 49, 245, 116, 246, 138, 161, 222, 65, 116, 18, 61, 227, 218, 154, 107, 172, 132, 119, 92, 126, 137, 33, 97, 243, 195, 200, 118, 12]!
And here&#39;s your flag: [2, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 2, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 196, 182, 72, 102, 37, 214, 250, 240, 211, 193, 251, 206, 179, 194, 23, 99, 88, 217, 216, 191, 130, 131, 52, 44, 174, 146, 211, 48, 39, 39, 20, 57, 144, 169, 11, 154, 215, 56, 164, 22, 46, 39, 71, 75, 208, 173, 225, 77, 2, 20, 34, 143, 222, 168, 158, 127, 15, 126, 143, 42, 125, 18, 239, 27]!
</code></pre><p>Basically it it generates a 32 bytes random key, AES encrypt the input flag with it, then performs a transformations on the key and output before printing it.</p>
<p>the applied transformation is either <code>reverse</code> or <code>xor</code> base on a random number % 2.</p>
<p><code>reverse</code> and <code>xor</code> are both methods of ``nuts_and_bolts::StorageMethod``` for which we do not have the source.</p>
<p>For <code>reverse</code> we assume it will just reverse the string (sorry :))</p>
<p>For <code>xor</code> we need to follow the breadcrumbs to <code>nuts_and_bolts::StorageMethod&lt;_&gt;::xor</code> -&gt; <code>nuts_and_bolts::StorageMethod&lt;_&gt;::xor_inner</code> -&gt;  <code>for_each</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">__thiscall</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">core</span><span class="o">::</span><span class="n">slice</span><span class="o">::</span><span class="n">iter</span><span class="o">::</span><span class="n">IterMut</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="n">_as_core</span><span class="o">::</span><span class="n">iter</span><span class="o">::</span><span class="n">traits</span><span class="o">::</span><span class="n">iterator</span><span class="o">::</span><span class="n">Iterator</span><span class="o">&gt;::</span><span class="n">for_each</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="o">&lt;</span><span class="n">core</span><span class="o">::</span><span class="n">slice</span><span class="o">::</span><span class="n">iter</span><span class="o">::</span><span class="n">IterMut</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="n">_as_core</span><span class="o">::</span><span class="n">iter</span><span class="o">::</span><span class="n">traits</span><span class="o">::</span><span class="n">iterator</span><span class="o">::</span><span class="n">Iterator</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span><span class="n">IterMut</span><span class="o">&lt;</span><span class="n">u8</span><span class="o">&gt;</span> <span class="n">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">Option</span><span class="o">&lt;&amp;</span><span class="n">mut_u8</span><span class="o">&gt;</span> <span class="n">param_3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="n">core</span><span class="o">::</span><span class="n">slice</span><span class="o">::</span><span class="n">iter</span><span class="o">::</span><span class="n">IterMut</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="n">_as_core</span><span class="o">::</span><span class="n">iter</span><span class="o">::</span><span class="n">traits</span><span class="o">::</span><span class="n">iterator</span><span class="o">::</span><span class="n">Iterator</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">local_40</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Option</span><span class="o">&lt;&amp;</span><span class="n">mut_u8</span><span class="o">&gt;</span> <span class="n">local_38</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="n">closure_env</span><span class="err">#</span><span class="mi">0</span><span class="p">}</span><span class="o">&lt;</span><span class="mi">64</span><span class="o">&gt;</span> <span class="n">local_30</span> <span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">Option</span><span class="o">&lt;&amp;</span><span class="n">mut_u8</span><span class="o">&gt;</span> <span class="n">local_28</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Option</span><span class="o">&lt;&amp;</span><span class="n">mut_u8</span><span class="o">&gt;</span> <span class="n">local_20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Option</span><span class="o">&lt;&amp;</span><span class="n">mut_u8</span><span class="o">&gt;</span> <span class="n">local_8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">local_40</span> <span class="o">=</span> <span class="n">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_38</span> <span class="o">=</span> <span class="n">param_3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">param_3</span> <span class="o">=</span> <span class="n">next</span><span class="p">((</span><span class="o">&lt;</span><span class="n">core</span><span class="o">::</span><span class="n">slice</span><span class="o">::</span><span class="n">iter</span><span class="o">::</span><span class="n">IterMut</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="n">_as_core</span><span class="o">::</span><span class="n">iter</span><span class="o">::</span><span class="n">traits</span><span class="o">::</span><span class="n">iterator</span><span class="o">::</span><span class="n">Iterator</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">local_40</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="p">(</span><span class="n">IterMut</span><span class="o">&lt;</span><span class="n">u8</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span><span class="n">param_3</span><span class="p">),</span> <span class="n">param_3</span> <span class="o">!=</span> <span class="p">(</span><span class="n">Option</span><span class="o">&lt;&amp;</span><span class="n">mut_u8</span><span class="o">&gt;</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">local_28</span> <span class="o">=</span> <span class="n">param_3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">local_20</span> <span class="o">=</span> <span class="n">param_3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">local_8</span> <span class="o">=</span> <span class="n">param_3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">nuts_and_bolts</span><span class="o">::</span><span class="n">StorageMethod</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;::</span><span class="n">xor_inner</span><span class="o">::</span><span class="p">{{</span><span class="n">closure</span><span class="p">}}(</span><span class="n">local_30</span><span class="p">,(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">param_3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>and then <code>nuts_and_bolts::StorageMethod&lt;_&gt;::xor_inner::{{closure}}</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">nuts_and_bolts</span><span class="o">::</span><span class="n">StorageMethod</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;::</span><span class="n">xor_inner</span><span class="o">::</span><span class="p">{{</span><span class="n">closure</span><span class="p">}}({</span><span class="n">closure_env</span><span class="err">#</span><span class="mi">0</span><span class="p">}</span><span class="o">&lt;</span><span class="mi">64</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">param_1</span><span class="p">,</span><span class="n">u8</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">v</span> <span class="o">=</span> <span class="o">*</span><span class="n">v</span> <span class="o">^</span> <span class="mh">0xd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>from there i took another shortcut:</p>
<ul>
<li>the first half of the output (0, 1, 2) is potentially a hint on the transformations to apply</li>
</ul>
<p>but:</p>
<ul>
<li>rev(rev(str)) == str</li>
<li>xor(xor(str, 0xd), 0xd) == str</li>
</ul>
<p>so maybe i can just try to bruteforce it, there&rsquo;s only 16 possibilites:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">xor</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># from output.txt</span>
</span></span><span class="line"><span class="cl"><span class="n">key</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">([</span><span class="mi">101</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">249</span><span class="p">,</span> <span class="mi">222</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">245</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">161</span><span class="p">,</span> <span class="mi">222</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">227</span><span class="p">,</span> \
</span></span><span class="line"><span class="cl">    <span class="mi">218</span><span class="p">,</span> <span class="mi">154</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">172</span><span class="p">,</span> <span class="mi">132</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">243</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">12</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">msg</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">([</span><span class="mi">196</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">214</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">211</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">251</span><span class="p">,</span> <span class="mi">206</span><span class="p">,</span> <span class="mi">179</span><span class="p">,</span> <span class="mi">194</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> \
</span></span><span class="line"><span class="cl">    <span class="mi">217</span><span class="p">,</span> <span class="mi">216</span><span class="p">,</span> <span class="mi">191</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">174</span><span class="p">,</span> <span class="mi">146</span><span class="p">,</span> <span class="mi">211</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">144</span><span class="p">,</span> <span class="mi">169</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">154</span><span class="p">,</span> <span class="mi">215</span><span class="p">,</span> \
</span></span><span class="line"><span class="cl">    <span class="mi">56</span><span class="p">,</span> <span class="mi">164</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">208</span><span class="p">,</span> <span class="mi">173</span><span class="p">,</span> <span class="mi">225</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">143</span><span class="p">,</span> <span class="mi">222</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span> <span class="mi">158</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> \
</span></span><span class="line"><span class="cl">    <span class="mi">126</span><span class="p">,</span> <span class="mi">143</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">239</span><span class="p">,</span> <span class="mi">27</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># all keys </span>
</span></span><span class="line"><span class="cl"><span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xor</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">),</span> <span class="n">xor</span><span class="p">(</span><span class="n">key</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mh">0xd</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># all msgs</span>
</span></span><span class="line"><span class="cl"><span class="n">msgs</span> <span class="o">=</span>  <span class="p">[</span><span class="n">msg</span><span class="p">,</span> <span class="n">msg</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xor</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">),</span> <span class="n">xor</span><span class="p">(</span><span class="n">msg</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mh">0xd</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_ECB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
</span></span></code></pre></div><pre tabindex="0"><code>% python nab.py | grep HTB
b&#39;HTB{ru5t_h45_t4gg3d_3num5_4nd_th3yr3_pr3tty_c00l}\n\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&#39;
</code></pre><h1 id="5-shuffleme">5. Shuffleme<a href="#5-shuffleme" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h1>
<p>Original files <a href="rev_shuffleme.zip">here</a>.</p>
<p>This is one i need to get back to, because i honestly didnt take time to understand what it was doing&hellip;</p>
<p>I either missed the obvious or there&rsquo;s some solid voodoo going on, but nevertheless got it with some solid shortcuts and a lot of luck maybe</p>
<p>The binary is not stripped and we can see the following in the <code>go</code>function:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl">    <span class="n">extract_blob</span><span class="p">(</span><span class="n">key_blob</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="n">extracted_key_blob</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">extract_blob</span><span class="p">(</span><span class="n">data_blob</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="n">extracted_data_blob</span><span class="p">);</span>
</span></span></code></pre></div><p>there&rsquo;s also <code>EVP_aes_256_cbc</code> in the imports.</p>
<pre tabindex="0"><code>% readelf -r shuffleme | grep EVP
000000202020  000600000007 R_X86_64_JUMP_SLO 0000000000000000 EVP_CIPHER_key_length@OPENSSL_1_1_0 + 0
000000202060  001200000007 R_X86_64_JUMP_SLO 0000000000000000 EVP_CIPHER_CTX_new@OPENSSL_1_1_0 + 0
0000002020d8  001600000007 R_X86_64_JUMP_SLO 0000000000000000 EVP_aes_256_cbc@OPENSSL_1_1_0 + 0
0000002020d0  001800000007 R_X86_64_JUMP_SLO 0000000000000000 EVP_CIPHER_iv_length@OPENSSL_1_1_0 + 0
000000202078  001b00000007 R_X86_64_JUMP_SLO 0000000000000000 EVP_CIPHER_CTX_free@OPENSSL_1_1_0 + 0
0000002020c8  001d00000007 R_X86_64_JUMP_SLO 0000000000000000 EVP_EncryptFinal_ex@OPENSSL_1_1_0 + 0
0000002020b8  001f00000007 R_X86_64_JUMP_SLO 0000000000000000 EVP_EncryptInit_ex@OPENSSL_1_1_0 + 0
000000202028  002000000007 R_X86_64_JUMP_SLO 0000000000000000 EVP_EncryptUpdate@OPENSSL_1_1_0 + 0
</code></pre><p>anyhow, i dumped the extracted key and data blob with gdb:</p>
<pre tabindex="0"><code>   0x0000555555400f7f &lt;+45&gt;:	lea    rdi,[rip+0x2012da]        # 0x555555602260 &lt;key_blob&gt;
   0x0000555555400f86 &lt;+52&gt;:	call   0x555555401005 &lt;extract_blob&gt;
...
   0x0000555555400f9e &lt;+76&gt;:	call   0x555555401005 &lt;extract_blob&gt;
   0x0000555555400fa3 &lt;+81&gt;:	mov    rax,QWORD PTR [rbp-0x88]

pwndbg&gt; break *go+52
Breakpoint 2 at 0x555555400f86
pwndbg&gt; break *go+57
Breakpoint 3 at 0x555555400f8b
pwndbg&gt; break *go+76
Breakpoint 4 at 0x555555400f9e
pwndbg&gt; break *go+81
Breakpoint 5 at 0x555555400fa3
pwndbg&gt; c
...
 ► 0x555555400f86 &lt;go+52&gt;    call   extract_blob                &lt;extract_blob&gt;
        rdi: 0x555555602260 (key_blob) ◂— 0x9f21016cc238d330
        rsi: 0x20
        rdx: 0x7fffffffe340 ◂— 0x0
        rcx: 0xfffffa00
pwndbg&gt; c
pwndbg&gt; x/32bx 0x7fffffffe340
0x7fffffffe340:	0x30	0x6c	0x03	0x7c	0x45	0xb0	0x41	0x32
0x7fffffffe348:	0xc0	0xc3	0xa7	0xb0	0x7f	0x72	0xcd	0x94
0x7fffffffe350:	0x75	0x8f	0x49	0x8b	0xb1	0xd8	0x3a	0x03
0x7fffffffe358:	0xd4	0x2f	0xa4	0x49	0x91	0x59	0x27	0xe7
pwndbg&gt; c
...
► 0x555555400f9e &lt;go+76&gt;    call   extract_blob                &lt;extract_blob&gt;
        rdi: 0x555555602120 (data_blob) ◂— 0xf8f1725539de5807
        rsi: 0x50
        rdx: 0x7fffffffe360 ◂— 0x0
        rcx: 0x7ffff7ffe050 (_rtld_global+4112) ◂— 0x7ffff7ffe050
pwndbg&gt; c
pwndbg&gt; x/80bx 0x7fffffffe360
0x7fffffffe360:	0x07	0x55	0xc5	0x7a	0x53	0xd9	0x3e	0xef
0x7fffffffe368:	0xcc	0xe9	0x39	0x7c	0xa8	0xa2	0x66	0x8f
0x7fffffffe370:	0x66	0x56	0x3a	0x17	0x84	0xbd	0xf5	0x2a
0x7fffffffe378:	0x4b	0xca	0x25	0x5a	0x2d	0x87	0xa0	0x8a
0x7fffffffe380:	0x04	0x94	0xd2	0x72	0x0e	0xb7	0xc6	0xf9
0x7fffffffe388:	0xf9	0xcd	0x91	0x0e	0x22	0x90	0xfc	0x15
0x7fffffffe390:	0xe6	0xd2	0x49	0x6a	0x74	0x38	0x86	0xdb
0x7fffffffe398:	0xca	0x0e	0xbd	0x7c	0x9c	0xe1	0x57	0xf0
0x7fffffffe3a0:	0x44	0x59	0x5a	0x10	0x1b	0xd4	0x6f	0x33
0x7fffffffe3a8:	0xe8	0x95	0xc3	0x82	0x67	0x96	0xb6	0x61
</code></pre><p>The extracted values are not dependant on the argv[1] input.</p>
<p>Then i decided to try AES on them, beause the length of the blob fits nicely into AES blocks, and&hellip; why not after all, doesnt take much time.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">key</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>     <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>     <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>     <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>     <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0xe7</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>     <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>     <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>     <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>     <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>     <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>     <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>     <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>     <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>     <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>     <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x61</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">key</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">c</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x86</span><span class="s1">#</span><span class="se">\x81</span><span class="s1">s</span><span class="se">\xb3\x04\xcd\x01\x80\xa8\xeb</span><span class="s1">4</span><span class="se">\x0e</span><span class="s1">L</span><span class="se">\x90</span><span class="s1">z3_4nd_sw1tch1ng_th3r3-1t5_m0r3_th4n_1_c4n_b34r!}</span><span class="se">\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10</span><span class="s1">&#39;</span>
</span></span></code></pre></div><p>I tried CBC first because of the import, the 1st block is garbage but then there&rsquo;s something looking like a flag.</p>
<p>At this point, why not try ECB too, i mean it&rsquo;s been a train of stupid but working ideas so far&hellip; :)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_ECB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">c</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="sa">b</span><span class="s1">&#39;HTB{sw4pp1ng_h3r4</span><span class="se">\n\xf1\x14</span><span class="s1">7</span><span class="se">\x86</span><span class="s1">M</span><span class="se">\x98\xfd\x9d</span><span class="s1">Z</span><span class="se">\x14\x99\xcc\x01\xd0\x12</span><span class="s1">&gt;</span><span class="se">\t</span><span class="s1">e</span><span class="se">\xb7\x90\xc4</span><span class="s1">^~</span><span class="se">\x95</span><span class="s1">Hj_</span><span class="se">\xb4\xff\xfe</span><span class="s1">l</span><span class="se">\xa0\xbc</span><span class="s1">-?</span><span class="se">\xe8\xa5\xcd\x97\x92\xf3</span><span class="s1">=</span><span class="se">\x16\xe2\xdd</span><span class="s1">h</span><span class="se">\xf6\xc2</span><span class="s1">Yzd(</span><span class="se">\x96\xcb\xda\x1e\xad</span><span class="s1">l</span><span class="se">\x8c\xf1</span><span class="s1">G</span><span class="se">\xe0</span><span class="s1">&#39;</span>
</span></span></code></pre></div><p>the the first part of the flag is revealed.</p>
<p>not really proud of myself on this one but a flag is a flag!</p>
<h1 id="6-snake-code">6. Snake Code<a href="#6-snake-code" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h1>
<p>Original files <a href="rev_snakecode.zip">here</a>.</p>
<p>This is a pure python challenge, we starts by using uncompyle6 on the pyc file.</p>
<p>It yields some proper code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># uncompyle6 version 3.5.0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Python bytecode 2.7 (62211)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Decompiled from: Python 2.7.5 (default, Nov 16 2020, 22:23:17)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># [GCC 4.8.5 20150623 (Red Hat 4.8.5-44)]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Embedded file name: ./snake_obf.py</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Compiled at: 2022-01-18 06:16:46</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">marshal</span><span class="o">,</span> <span class="nn">types</span><span class="o">,</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="n">ll</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">(</span><span class="n">marshal</span><span class="o">.</span><span class="n">loads</span><span class="p">((</span><span class="s1">&#39;YwEAAAABAAAABQAAAEMAAABzNAAAAHQAAGoBAHQCAGoDAHQEAGQBAIMBAGoFAHwAAGoGAGQCAIMB</span><span class="se">\n</span><span class="s1">AIMBAIMBAHQHAIMAAIMCAFMoAwAAAE50BAAAAHpsaWJ0BgAAAGJhc2U2NCgIAAAAdAUAAAB0eXBl</span><span class="se">\n</span><span class="s1">c3QMAAAARnVuY3Rpb25UeXBldAcAAABtYXJzaGFsdAUAAABsb2Fkc3QKAAAAX19pbXBvcnRfX3QK</span><span class="se">\n</span><span class="s1">AAAAZGVjb21wcmVzc3QGAAAAZGVjb2RldAcAAABnbG9iYWxzKAEAAAB0AQAAAHMoAAAAACgAAAAA</span><span class="se">\n</span><span class="s1">cwcAAAA8c3RkaW4+dAoAAABsb2FkTGFtYmRhAQAAAHQAAAAA</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">)),</span> <span class="nb">globals</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">i0</span> <span class="o">=</span> <span class="n">ll</span><span class="p">(</span><span class="s1">&#39;eJxLZoACJiB2BuJiLiBRwsCQwsjQzMgQrAES9ythA5JFiXkp+bkajCB5kKL4+Mzcgvyikvh4DZAB</span><span class="se">\n</span><span class="s1">CKKYHUjYFJekZObZlXCA2DmJuUkpiXaMEKMZGAC+nBJh</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">i1</span> <span class="o">=</span> <span class="n">ll</span><span class="p">(</span><span class="s1">&#39;eJxLZoACJiB2BuJiLiBRwsCQwsjQzMgQrAES9ythA5LJpUXFqcUajCB5kKL4+Mzcgvyikvh4DZAB</span><span class="se">\n</span><span class="s1">CKKYHUjYFJekZObZlXCA2DmJuUkpiXaMEKMZGADEORJ1</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">f0</span> <span class="o">=</span> <span class="n">ll</span><span class="p">(</span><span class="s1">&#39;eJxLZmRgYABhJiB2BuJiXiBRw8CQxcCQwsjQzMgQrAGS8ssEEgwaIJUl7CAiMzc1v7QEIsAMJMoz</span><span class="se">\n</span><span class="s1">8zTASkBEMUiJTXFJSmaeXQkHiJ2TmJuUkmgHVg5SAQBjWRD5</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#...</span>
</span></span><span class="line"><span class="cl"><span class="c1">#...</span>
</span></span><span class="line"><span class="cl"><span class="c1">#...</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">snake</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">i0</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">i1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">f0</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="n">pl</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">l</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">m2</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">i1</span><span class="p">()</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">snake</span><span class="p">)</span>
</span></span></code></pre></div><p>clearly the <code>ll</code> function loads more code.</p>
<p>We can reverse marshall&rsquo;d code using <a href="https://gist.github.com/stecman/3751ac494795164efa82a683130cabe5#file-marshal-to-pyc-py">marshal-to-pyc.py</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="err">$</span> <span class="n">echo</span> <span class="o">-</span><span class="n">n</span> <span class="err">$</span><span class="s1">&#39;YwEAAAABAAAABQAAAEMAAABzNAAAAHQAAGoBAHQCAGoDAHQEAGQBAIMBAGoFAHwAAGoGAGQCAIMB</span><span class="se">\n</span><span class="s1">AIMBAIMBAHQHAIMAAIMCAFMoAwAAAE50BAAAAHpsaWJ0BgAAAGJhc2U2NCgIAAAAdAUAAAB0eXBl</span><span class="se">\n</span><span class="s1">c3QMAAAARnVuY3Rpb25UeXBldAcAAABtYXJzaGFsdAUAAABsb2Fkc3QKAAAAX19pbXBvcnRfX3QK</span><span class="se">\n</span><span class="s1">AAAAZGVjb21wcmVzc3QGAAAAZGVjb2RldAcAAABnbG9iYWxzKAEAAAB0AQAAAHMoAAAAACgAAAAA</span><span class="se">\n</span><span class="s1">cwcAAAA8c3RkaW4+dAoAAABsb2FkTGFtYmRhAQAAAHQAAAAA</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">|</span> <span class="n">base64</span> <span class="o">-</span><span class="n">d</span>  <span class="o">&gt;</span> <span class="n">ll</span><span class="o">.</span><span class="n">bin</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">$</span> <span class="n">python</span> <span class="n">marshal</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">pyc</span><span class="o">.</span><span class="n">py</span> <span class="n">ll</span><span class="o">.</span><span class="n">bin</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">$</span>  <span class="n">cat</span> <span class="n">ll</span><span class="o">.</span><span class="n">bin</span><span class="o">.</span><span class="n">py</span>
</span></span><span class="line"><span class="cl"><span class="c1"># uncompyle6 version 3.8.0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Python bytecode 2.7 (62211)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Decompiled from: Python 2.7.16 (default, Oct 10 2019, 22:02:15) </span>
</span></span><span class="line"><span class="cl"><span class="c1"># [GCC 8.3.0]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Warning: this version of Python has problems handling the Python 3 byte type in constants properly.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Embedded file name: &lt;stdin&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Compiled at: 2022-05-21 08:34:32</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">(</span><span class="n">marshal</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;zlib&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">))),</span> <span class="nb">globals</span><span class="p">())</span>
</span></span></code></pre></div><p>All we have to do now is to decompile the rest of the functions, we just need to <code>zlib.decompress</code> them.</p>
<p>I quickly modified the intial file so that <code>ll</code> dumps me the data to files:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">ll</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;out/&#34;</span><span class="o">+</span><span class="n">name</span><span class="p">,</span> <span class="s2">&#34;wb&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;base64&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">i0</span> <span class="o">=</span> <span class="n">ll</span><span class="p">(</span><span class="s2">&#34;i0&#34;</span><span class="p">,</span> <span class="s1">&#39;eJxLZoACJiB2BuJiLiBRwsCQwsjQzMgQrAES9ythA5JFiXkp+bkajCB5kKL4+Mzcgvyikvh4DZAB</span><span class="se">\n</span><span class="s1">CKKYHUjYFJekZObZlXCA2DmJuUkpiXaMEKMZGAC+nBJh</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">i1</span> <span class="o">=</span> <span class="n">ll</span><span class="p">(</span><span class="s2">&#34;i1&#34;</span><span class="p">,</span> <span class="s1">&#39;eJxLZoACJiB2BuJiLiBRwsCQwsjQzMgQrAES9ythA5LJpUXFqcUajCB5kKL4+Mzcgvyikvh4DZAB</span><span class="se">\n</span><span class="s1">CKKYHUjYFJekZObZlXCA2DmJuUkpiXaMEKMZGADEORJ1</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">f0</span> <span class="o">=</span> <span class="n">ll</span><span class="p">(</span><span class="s2">&#34;f0&#34;</span><span class="p">,</span> <span class="s1">&#39;eJxLZmRgYABhJiB2BuJiXiBRw8CQxcCQwsjQzMgQrAGS8ssEEgwaIJUl7CAiMzc1v7QEIsAMJMoz</span><span class="se">\n</span><span class="s1">8zTASkBEMUiJTXFJSmaeXQkHiJ2TmJuUkmgHVg5SAQBjWRD5</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># etc...</span>
</span></span></code></pre></div><pre tabindex="0"><code>out$ ls
a1  a2  a4  a5  a6  a7  a8  a9  f0  f1  f2  f3  f4  f5  f6  f7  f8  i0  i1  m0  m1  m2

out$ for x in *; do python ../marshal-to-pyc.py $x; done

out$ cat a2.py
# uncompyle6 version 3.8.0
# Python bytecode 2.7 (62211)
# Decompiled from: Python 2.7.16 (default, Oct 10 2019, 22:02:15) 
# [GCC 8.3.0]
# Warning: this version of Python has problems handling the Python 3 byte type in constants properly.

# Embedded file name: &lt;stdin&gt;
# Compiled at: 2022-05-21 08:39:47
f = [&#39;H&#39;, &#39;T&#39;, &#39;B&#39;, &#39;{&#39;, &#39;S&#39;, &#39;u&#39;, &#39;P&#39;, &#39;3&#39;, &#39;r&#39;, &#39;_&#39;, &#39;S&#39;, &#39;3&#39;, &#39;C&#39;, &#39;R&#39;, &#39;t&#39;, &#39;_&#39;, &#39;S&#39;, &#39;n&#39;, &#39;4&#39;, &#39;k&#39;, &#39;3&#39;, &#39;c&#39;, &#39;0&#39;, &#39;d&#39;, &#39;3&#39;, &#39;}&#39;]
return f[(pl / 5 % len(f))](venv2) 

out$ python
&gt;&gt;&gt; f = [&#39;H&#39;, &#39;T&#39;, &#39;B&#39;, &#39;{&#39;, &#39;S&#39;, &#39;u&#39;, &#39;P&#39;, &#39;3&#39;, &#39;r&#39;, &#39;_&#39;, &#39;S&#39;, &#39;3&#39;, &#39;C&#39;, &#39;R&#39;, &#39;t&#39;, &#39;_&#39;, &#39;S&#39;, &#39;n&#39;, &#39;4&#39;, &#39;k&#39;, &#39;3&#39;, &#39;c&#39;, &#39;0&#39;, &#39;d&#39;, &#39;3&#39;, &#39;}&#39;]
&gt;&gt;&gt; 
&gt;&gt;&gt; &#39;&#39;.join(f)
&#39;HTB{SuP3r_S3CRt_Sn4k3c0d3}&#39;
</code></pre><h1 id="7-freaky-forum-interception">7. Freaky Forum Interception<a href="#7-freaky-forum-interception" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h1>
<p>Original files <a href="rev_ffi.zip">here</a>.</p>
<p>This one makes heavy use of <a href="https://en.wikipedia.org/wiki/Foreign_function_interface">FFI</a>, which makes it one big mess :-)</p>
<p>If we start with the <code>main</code> function, we understand that the flag will need to be of the following format:</p>
<p><code>HTB{part1_part2_part3_part4}</code></p>
<ul>
<li>part1 will be validated by the <code>GoCheck</code>function</li>
<li>part2 will be validated by the <code>rust_check</code> function</li>
<li>part3 will be validated by the <code>python_check</code> function</li>
<li>part4 will be validated by the <code>java_check</code>function.</li>
</ul>
<h2 id="71-gocheck">7.1 GoCheck<a href="#71-gocheck" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>When dealing with a Go binary in Ghidra, you might want to check the <code>Decompiler Parameter ID</code>in the analysis option (by pressing &lsquo;A&rsquo;) - otherwise most function calls will look like they have no parameters.</p>
<p>Basically there&rsquo;s a channel between <code>main.Waiter</code> and <code>main.Oracle</code>.</p>
<p>The <code>main.Oracle</code> is feeding expected characters and positions read from the data pointed by <code>main.g</code></p>
<pre tabindex="0"><code>                         main.g                                                       XREF[1]:   main.Oracle:001b6c92(R)  
      003491f0 40 bd 34 00 00 00 00     addr                 main..stmp_0
               00
</code></pre><p>we can quickly dump the table with GDB</p>
<pre tabindex="0"><code> ► 0x55555560accb &lt;main.Oracle+107&gt;    mov    rdx, qword ptr [rcx]          &lt;main..stmp_0&gt;

pwndbg&gt; x/16gx $rcx
0x55555579fd40 &lt;main..stmp_0&gt;:  	0x0000000000000002	0x0000000000000074
0x55555579fd50 &lt;main..stmp_0+16&gt;:	0x0000000000000006	0x0000000000000067
0x55555579fd60 &lt;main..stmp_0+32&gt;:	0x0000000000000003	0x0000000000000074
0x55555579fd70 &lt;main..stmp_0+48&gt;:	0x0000000000000004	0x0000000000000031
0x55555579fd80 &lt;main..stmp_0+64&gt;:	0x0000000000000001	0x0000000000000033
0x55555579fd90 &lt;main..stmp_0+80&gt;:	0x0000000000000000	0x0000000000000067
0x55555579fda0 &lt;main..stmp_0+96&gt;:	0x0000000000000005	0x000000000000006e
0x55555579fdb0:	0x0000000000000000	0x0000000000000000
</code></pre><p>first &ldquo;column&rdquo; is the position, 2nd one is the character</p>
<pre tabindex="0"><code>&gt;&gt;&gt; chr(0x0000000000000067) + chr(0x0000000000000033) + chr(0x0000000000000074) + chr(0x0000000000000074) + chr(0x0000000000000031) + chr(0x000000000000006e) + chr(0x0000000000000067)
&#39;g3tt1ng&#39;
</code></pre><h2 id="72-rust_check">7.2 rust_check<a href="#72-rust_check" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>It starts by checking the length of the flag part which must be 6 characters,</p>
<p>then checks that the sum of all input chars is 0x223:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">param_2</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">bVar2</span> <span class="o">=</span> <span class="o">*</span><span class="n">input_flag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="n">byte</span><span class="p">)(</span><span class="o">~</span><span class="n">bVar2</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">byte</span><span class="p">)(</span><span class="n">bVar2</span> <span class="o">+</span> <span class="mh">0xbf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x1a</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">bVar3</span> <span class="o">=</span> <span class="n">input_flag</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">((</span><span class="n">byte</span><span class="p">)(</span><span class="o">~</span><span class="n">bVar3</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">byte</span><span class="p">)(</span><span class="n">bVar3</span> <span class="o">+</span> <span class="mh">0xbf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x1a</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">bVar4</span> <span class="o">=</span> <span class="n">input_flag</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">((</span><span class="n">byte</span><span class="p">)(</span><span class="o">~</span><span class="n">bVar4</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">byte</span><span class="p">)(</span><span class="n">bVar4</span> <span class="o">+</span> <span class="mh">0xbf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x1a</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">bVar5</span> <span class="o">=</span> <span class="n">input_flag</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">((</span><span class="n">byte</span><span class="p">)(</span><span class="o">~</span><span class="n">bVar5</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">byte</span><span class="p">)(</span><span class="n">bVar5</span> <span class="o">+</span> <span class="mh">0xbf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x1a</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">bVar6</span> <span class="o">=</span> <span class="n">input_flag</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">((</span><span class="n">byte</span><span class="p">)(</span><span class="o">~</span><span class="n">bVar6</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">byte</span><span class="p">)(</span><span class="n">bVar6</span> <span class="o">+</span> <span class="mh">0xbf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x1a</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">bVar7</span> <span class="o">=</span> <span class="n">input_flag</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="p">(((</span><span class="n">byte</span><span class="p">)(</span><span class="o">~</span><span class="n">bVar7</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">byte</span><span class="p">)(</span><span class="n">bVar7</span> <span class="o">+</span> <span class="mh">0xbf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x1a</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                               <span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">bVar7</span> <span class="o">+</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">bVar6</span> <span class="o">+</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">bVar5</span> <span class="o">+</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">bVar4</span> <span class="o">+</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">bVar2</span> <span class="o">+</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">bVar3</span> <span class="o">==</span> <span class="mh">0x223</span><span class="p">))</span> <span class="p">{</span>
</span></span></code></pre></div><p>afterwards it checks that:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"> <span class="p">((((((</span><span class="n">ulong</span><span class="p">)</span><span class="o">*</span><span class="n">input_flag</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">input_flag</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">input_flag</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">input_flag</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">input_flag</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">input_flag</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x8dd3</span><span class="p">))</span>
</span></span></code></pre></div><p>then it calls this from_iter() and build and compare the resulting array to some hardcoded table.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="n">alloc</span><span class="o">::</span><span class="n">vec</span><span class="o">::</span><span class="n">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="n">as_alloc</span><span class="o">::</span><span class="n">vec</span><span class="o">::</span><span class="n">spec_from_iter</span><span class="o">::</span><span class="n">SpecFromIter</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">I</span><span class="o">&gt;&gt;::</span><span class="n">from_iter</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="o">&amp;</span><span class="n">local_68</span><span class="p">,(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ptr_input_flag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">local_58</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">iVar8</span> <span class="o">=</span> <span class="n">bcmp</span><span class="p">(</span><span class="n">local_68</span><span class="p">,</span><span class="n">QWORD_ARRAY_00279ca0</span><span class="p">,</span><span class="mh">0x30</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">bVar10</span> <span class="o">=</span> <span class="n">iVar8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><p>This <code>from_iter</code> function sums the first and last chr, the 2nd and before-last, etc&hellip;</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl">    <span class="n">flag_chr0</span> <span class="o">=</span> <span class="o">*</span><span class="n">param_2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">flag_char1</span> <span class="o">=</span> <span class="n">param_2</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">flag_char2</span> <span class="o">=</span> <span class="n">param_2</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">flag_char3</span> <span class="o">=</span> <span class="n">param_2</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">lVar1</span> <span class="o">=</span> <span class="n">flag_chr0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(;</span> <span class="p">(</span><span class="n">lVar1</span> <span class="o">!=</span> <span class="n">flag_char1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flag_char3</span> <span class="o">!=</span> <span class="n">flag_char2</span><span class="p">));</span> <span class="n">flag_char3</span> <span class="o">=</span> <span class="n">flag_char3</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">*</span><span class="p">(</span><span class="n">ulong</span> <span class="o">*</span><span class="p">)(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">flag_char3</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">flag_chr0</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">lVar1</span> <span class="o">=</span> <span class="n">flag_chr0</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">param_1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span></span></code></pre></div><p>if we dump the table we are looking for we have enough informations to guess this part of the flag:</p>
<pre tabindex="0"><code>pwndbg&gt; x/48bx $rsi
0x5555556cdca0:	0xdf	0x00	0x00	0x00	0x00	0x00	0x00	0x00
0x5555556cdca8:	0xdd	0x00	0x00	0x00	0x00	0x00	0x00	0x00
0x5555556cdcb0:	0x67	0x00	0x00	0x00	0x00	0x00	0x00	0x00
0x5555556cdcb8:	0x67	0x00	0x00	0x00	0x00	0x00	0x00	0x00
0x5555556cdcc0:	0xdd	0x00	0x00	0x00	0x00	0x00	0x00	0x00
0x5555556cdcc8:	0xdf	0x00	0x00	0x00	0x00	0x00	0x00	0x00
</code></pre><p>which means we need:</p>
<pre tabindex="0"><code>flag[0] + flag[5] == 0xdf
flag[1] + flag[4] == 0xdd
flag[2] + flag[3] == 0x67
</code></pre><p>People who like to suffer can keep reversing rust for more hints, at this point I just bruteforced it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">z3</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">FLAG</span> <span class="o">=</span> <span class="s2">&#34;HTB{g3tt1ng_</span><span class="si">%s</span><span class="s2">_part3_part4}&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">BitVec</span><span class="p">(</span><span class="s1">&#39;f</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">x</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">flag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">Or</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">And</span><span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="mi">48</span><span class="p">,</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">65</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="n">And</span><span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">,</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="mi">122</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">flag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">flag</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">flag</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">flag</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">flag</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">flag</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x223</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(((((</span><span class="n">flag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">flag</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">flag</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">flag</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">flag</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">flag</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x8dd3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">flag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">flag</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xdf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">flag</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">flag</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xdd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">flag</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">flag</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x67</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;error&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./ffi&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">FLAG</span><span class="o">%</span><span class="n">password</span><span class="p">,</span> <span class="s1">&#39;ascii&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39;Rust says no!&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">FLAG</span><span class="o">%</span><span class="n">password</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span> <span class="o">==</span> <span class="n">sat</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">condition</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flag</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">flag</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span><span class="o">.</span><span class="n">as_long</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">condition</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">flag</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span><span class="o">.</span><span class="n">as_long</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Or</span><span class="p">(</span><span class="n">condition</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">check</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span></span></code></pre></div><pre tabindex="0"><code>% python rust_gen2.py
HTB{g3tt1ng_fr34ky_part3_part4}
</code></pre><h2 id="73-python_check">7.3 python_check<a href="#73-python_check" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>the python check expects a 5 chrs flag</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Py_Initialize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">seed</span><span class="p">(</span><span class="mh">0x7a69</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">GetNum</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">PyCMethod_New</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GenDef</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">num</span> <span class="o">=</span> <span class="n">PyObject_CallNoArgs</span><span class="p">(</span><span class="n">GetNum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">key_char</span> <span class="o">=</span> <span class="n">PyLong_AsLong</span><span class="p">(</span><span class="n">num</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Py_DecRef</span><span class="p">(</span><span class="n">num</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">((</span><span class="n">local_1e</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">secret</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">flag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">key_char</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">local_1e</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">local_1e</span> <span class="o">=</span> <span class="sc">&#39;\x01&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">_Py_DECREF</span><span class="p">(</span><span class="n">GetNum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Py_Finalize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></div><ul>
<li>it initializes the seed with 0x7a69</li>
<li>then for every chrs
<ul>
<li>calls a python method</li>
<li>cast the result to long</li>
<li>check that flag[i] ^ result == secret[i]</li>
</ul>
</li>
</ul>
<p>the <code>seed</code> function calls the python <code>random.seed()</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">seed</span><span class="p">(</span><span class="kt">int</span> <span class="n">seed_value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="o">*</span><span class="n">method_seed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">undefined8</span> <span class="n">seed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="o">*</span><span class="n">seed_tuple</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">randomMod</span> <span class="o">=</span> <span class="n">PyImport_ImportModule</span><span class="p">(</span><span class="s">&#34;random&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">method_seed</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">PyObject_GetAttrString</span><span class="p">(</span><span class="n">randomMod</span><span class="p">,</span><span class="s">&#34;seed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">seed</span> <span class="o">=</span> <span class="n">PyLong_FromLong</span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">seed_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">seed_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">PyTuple_New</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">PyTuple_SetItem</span><span class="p">(</span><span class="n">seed_tuple</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">seed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">PyObject_CallObject</span><span class="p">(</span><span class="n">method_seed</span><span class="p">,</span><span class="n">seed_tuple</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_Py_DECREF</span><span class="p">(</span><span class="n">seed_tuple</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_Py_DECREF</span><span class="p">(</span><span class="n">method_seed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The value of <code>secret</code> is no secret:</p>
<pre tabindex="0"><code>                         secret                                                       XREF[2]:   python_check:00267dd3(*), python_check:00267dda(R)
      0034b8b0 22 af 2d 26 3b           undefined5           002DAF223Bh
</code></pre><p>To know which python method is called in the main loop, we need to look at the <code>GenDef</code> address.</p>
<p>The <code>PyCMethod_New</code> first argument must be a <a href="https://docs.python.org/3/c-api/structures.html#c.PyMethodDef">PyMethodDef</a>. (<em>see methodobject.h</em>)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">PyMethodDef</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span>  <span class="o">*</span><span class="n">ml_name</span><span class="p">;</span>   <span class="cm">/* The name of the built-in function/method */</span>
</span></span><span class="line"><span class="cl">    <span class="n">PyCFunction</span> <span class="n">ml_meth</span><span class="p">;</span>    <span class="cm">/* The C function that implements it */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span>         <span class="n">ml_flags</span><span class="p">;</span>   <span class="cm">/* Combination of METH_xxx flags, which mostly
</span></span></span><span class="line"><span class="cl"><span class="cm">                               describe the args expected by the C func */</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span>  <span class="o">*</span><span class="n">ml_doc</span><span class="p">;</span>    <span class="cm">/* The __doc__ attribute, or NULL */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">PyMethodDef</span> <span class="n">PyMethodDef</span><span class="p">;</span>
</span></span></code></pre></div><p>so if we quickly cast 4 pointers in place of &ldquo;GenDef&rdquo; we get:</p>
<pre tabindex="0"><code>                         GenDef                                                       XREF[1]:   python_check:00267d84(*)
      0034b8c0 24 f6 29 00 00 00 00     addr                 s_rand_stream_0029f624                                                                   = &#34;rand_stream&#34;
               00
      0034b8c8 c0 7c 26 00 00 00 00     addr                 GetNum
               00
      0034b8d0 80 00 00 00 00 00 00     addr                 DAT_00000080
               00
      0034b8d8 00 00 00 00 00 00 00     addr                 00000000
               00
</code></pre><p>and the <code>GetNum</code> function, which calls the python <code>random.randrange(0x100)</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">long</span> <span class="o">*</span> <span class="nf">GetNum</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="o">*</span><span class="n">randrange</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="o">*</span><span class="n">not_so_random_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">randrange</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">PyObject_GetAttrString</span><span class="p">(</span><span class="n">randomMod</span><span class="p">,</span><span class="s">&#34;randrange&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">PyLong_FromLong</span><span class="p">(</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">not_so_random_value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">PyObject_CallOneArg</span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">randrange</span><span class="p">,(</span><span class="kt">long</span><span class="p">)</span><span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_Py_DECREF</span><span class="p">(</span><span class="n">randrange</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_Py_DECREF</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_Py_INCREF</span><span class="p">(</span><span class="n">not_so_random_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">not_so_random_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The seed sets the initial state of the RNG, so same seed means same output.</p>
<p>We can easily reimplement it in python:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mh">0x7a69</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">secret</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x22</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">secret</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">v</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">flag</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">s</span> <span class="o">^</span> <span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span></code></pre></div><pre tabindex="0"><code>% python pyt_check.py
u51Ng
</code></pre><h2 id="74-java_check">7.4 java_check<a href="#74-java_check" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>Whenever you have to deal with JNI, start by loading the proper jni.h header (you can get one which works for ghidra: <a href="https://github.com/extremecoders-re/ghidra-jni">https://github.com/extremecoders-re/ghidra-jni</a>).</p>
<p>then you can cast the JNIEnv and JavaVM, and everything becomes clear :)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl">    <span class="n">java_vm</span> <span class="o">=</span> <span class="n">JNI_CreateJavaVM</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jvm</span><span class="p">,</span><span class="o">&amp;</span><span class="n">env</span><span class="p">,</span><span class="o">&amp;</span><span class="n">vm_args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">java_vm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">class_Checker</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">DefineClass</span><span class="p">)(</span><span class="n">env</span><span class="p">,</span><span class="s">&#34;Checker&#34;</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,(</span><span class="n">jbyte</span> <span class="o">*</span><span class="p">)</span><span class="n">Class</span><span class="p">,</span><span class="mh">0x752</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ExceptionDescribe</span><span class="p">)(</span><span class="n">env</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">class_Checker</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Failed to find Checker class&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">bVar3</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">met_hello_java</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">GetStaticMethodID</span><span class="p">)(</span><span class="n">env</span><span class="p">,</span><span class="n">class_Checker</span><span class="p">,</span><span class="s">&#34;hello_java&#34;</span><span class="p">,</span><span class="s">&#34;(Ljava/lang/String;)Z&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">met_hello_java</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Failed to find main function&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">bVar3</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">str_flag</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">)(</span><span class="n">env</span><span class="p">,</span><span class="n">flag_part</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">jVar1</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">CallStaticBooleanMethod</span><span class="p">)(</span><span class="n">env</span><span class="p">,</span><span class="n">class_Checker</span><span class="p">,</span><span class="n">met_hello_java</span><span class="p">,</span><span class="n">str_flag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">bVar3</span> <span class="o">=</span> <span class="n">jVar1</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">free</span><span class="p">(</span><span class="n">flag_part</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></div><ul>
<li>it starts by loading a <code>Checker</code>class from a 0x752 bytes binary blob <code>Class</code></li>
<li>finds the <code>Class.hello_java</code> method which takes a single String argument</li>
<li>creates a java String object from the flag</li>
<li>calls Checker.hello_java(flag)</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="n">class_Checker</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">DefineClass</span><span class="p">)(</span><span class="n">env</span><span class="p">,</span><span class="s">&#34;Checker&#34;</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,(</span><span class="n">jbyte</span> <span class="o">*</span><span class="p">)</span><span class="n">Class</span><span class="p">,</span><span class="mh">0x752</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">met_hello_java</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">GetStaticMethodID</span><span class="p">)(</span><span class="n">env</span><span class="p">,</span><span class="n">class_Checker</span><span class="p">,</span><span class="s">&#34;hello_java&#34;</span><span class="p">,</span><span class="s">&#34;(Ljava/lang/String;)Z&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">str_flag</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">)(</span><span class="n">env</span><span class="p">,</span><span class="n">flag_part</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">CallStaticBooleanMethod</span><span class="p">)(</span><span class="n">env</span><span class="p">,</span><span class="n">class_Checker</span><span class="p">,</span><span class="n">met_hello_java</span><span class="p">,</span><span class="n">str_flag</span><span class="p">);</span>
</span></span></code></pre></div><p>Notice the java magic string <code>cafebabe</code>, it&rsquo;s a class file.</p>
<pre tabindex="0"><code>                         Class                                                        XREF[2]:   Entry Point(*), java_check:00267f6f(*)
      0029f722 ca fe ba be 00 00 00     db[1874]
               37 00 61 0a 00 0b 00
               1d 0a 00 1e 00 1f 0
         0029f722 [0]           CAh, FEh, BAh, BEh
         0029f726 [4]            0h,  0h,  0h, 37h
         0029f72a [8]            0h, 61h,  Ah,  0h
         0029f72e [12]           Bh,  0h, 1Dh,  Ah
</code></pre><p>export the <code>Class</code> binary blob and safe it to a file, then use <a href="https://github.com/skylot/jadx">jadx</a> or so to decompile it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.stream.IntStream</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* renamed from: Checker */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* loaded from: java.class */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Checker</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">hello_java</span><span class="o">(</span><span class="n">String</span> <span class="n">str</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span><span class="o">[]</span> <span class="n">iArr</span> <span class="o">=</span> <span class="o">{</span><span class="n">219</span><span class="o">,</span> <span class="n">227</span><span class="o">,</span> <span class="n">209</span><span class="o">,</span> <span class="n">154</span><span class="o">,</span> <span class="n">104</span><span class="o">,</span> <span class="n">97</span><span class="o">,</span> <span class="n">158</span><span class="o">,</span> <span class="n">163</span><span class="o">};</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">IntStream</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">str</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="n">1</span><span class="o">).</span><span class="na">mapToObj</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">),</span> <span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">str</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span><span class="o">)),</span> <span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">str</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">1</span><span class="o">))};</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">filter</span><span class="o">(</span><span class="n">objArr</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">((</span><span class="n">Integer</span><span class="o">)</span> <span class="n">objArr</span><span class="o">[</span><span class="n">1</span><span class="o">]).</span><span class="na">intValue</span><span class="o">()</span> <span class="o">+</span> <span class="o">((</span><span class="n">Integer</span><span class="o">)</span> <span class="n">objArr</span><span class="o">[</span><span class="n">2</span><span class="o">]).</span><span class="na">intValue</span><span class="o">()</span> <span class="o">==</span> <span class="n">iArr</span><span class="o">[((</span><span class="n">Integer</span><span class="o">)</span> <span class="n">objArr</span><span class="o">[</span><span class="n">0</span><span class="o">]).</span><span class="na">intValue</span><span class="o">()];</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">count</span><span class="o">()</span> <span class="o">==</span> <span class="o">((</span><span class="kt">long</span><span class="o">)</span> <span class="o">(</span><span class="n">str</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="n">1</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>what it does is, if you input the string <code>ABC</code>, it build an array like</p>
<pre tabindex="0"><code>[
 [0, 0x41 /* A */, 0x42 /* B */]
 [1, 0x42 /* B */, 0x43 /* C */]
 [1, 0x43 /* C */, 0x44 /* D */]
]
</code></pre><p>and then check that:</p>
<pre tabindex="0"><code> 0x41 + 0x42 == iArr[0]
 0x42 + 0x43 == iArr[1]
 0x43 + 0x43 == iArr[2]
</code></pre><p>we can quickly reverse it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">z3</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">iArr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">219</span><span class="p">,</span> <span class="mi">227</span><span class="p">,</span> <span class="mi">209</span><span class="p">,</span> <span class="mi">154</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">158</span><span class="p">,</span> <span class="mi">163</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">LEN</span> <span class="o">=</span> <span class="mi">9</span>
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">LEN</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span> <span class="o">=</span> <span class="n">BitVec</span><span class="p">(</span><span class="s1">&#39;c</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">c</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">flag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">And</span><span class="p">(</span><span class="n">e</span> <span class="o">&gt;=</span> <span class="mi">33</span><span class="p">,</span> <span class="n">e</span> <span class="o">&lt;=</span> <span class="mi">122</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">flag</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">flag</span><span class="p">[</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">iArr</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span> <span class="o">==</span> <span class="n">sat</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">condition</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flag</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">flag</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span><span class="o">.</span><span class="n">as_long</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">condition</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">flag</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span><span class="o">.</span><span class="n">as_long</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Or</span><span class="p">(</span><span class="n">condition</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span></span></code></pre></div><pre tabindex="0"><code>% python java_solver.py
irq`:.3k8
dwle53.p3
lot]=+6h;
kps^&lt;,5i:
jqr_;-4j9
func710n5       &lt;&lt; looking promising
gtob801m6
hspa9/2l7
nmv[?)8f=
pkxYA&#39;:d?
olwZ@(9e&gt;
evmd62/o4
mnu\&gt;*7g&lt;
byjg35,r1
rizWC%&lt;bA
cxkf44-q2
azih26+s0
qjyXB&amp;;c@
</code></pre><pre tabindex="0"><code>% ./ffi
HTB{g3tt1ng_fr34ky_u51Ng_func710n5}
Correct!
</code></pre><p><em>notes: the program would validate other inputs for the java part:</em></p>
<pre tabindex="0"><code>% ./ffi                                      
HTB{g3tt1ng_fr34ky_u51Ng_gtob801m6}
Correct!
</code></pre><p><em>and the go function is just bugged:</em></p>
<pre tabindex="0"><code>% ./ffi
HTB{sxxxxxx_fr34ky_u51Ng_hspa9/2l7}
Correct!
</code></pre><h1 id="8-indefinite">8. Indefinite<a href="#8-indefinite" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h1>
<p>Original files <a href="rev_indefinite.zip">here</a>.</p>
<p>I really liked this one because it implements nanomites, dont ask me why i like them&hellip; :)</p>
<p>We have a binary and an encrypted file that we need to decrypt.</p>
<p>It starts by forking:</p>
<ul>
<li>the child process will do the work</li>
<li>the parent process will attach to the child process and &ldquo;drive&rdquo; it</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="n">undefined8</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span><span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">uint</span> <span class="n">pid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* make text segment PROT_READ|PROT_WRITE|PROT_EXEC */</span>
</span></span><span class="line"><span class="cl">    <span class="n">mprotect</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x101000</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">,</span><span class="mi">7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_TRACEME</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">child</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">wait</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_CONT</span><span class="p">,(</span><span class="n">ulong</span><span class="p">)</span><span class="n">pid</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">tracer</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The <code>child</code> function will read 8 bytes from /dev/urandom and encrypt the file passed as argv[1]</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl">    <span class="n">fd</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&#34;/dev/urandom&#34;</span><span class="p">,</span><span class="s">&#34;r&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">fread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">fclose</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">do_encrypt_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">buffer</span><span class="p">);</span>
</span></span></code></pre></div><p>The <code>do_encrypt</code> function&hellip; will crash:</p>
<pre tabindex="0"><code>                         *******************************************************
                         *                                                     *
                         *  FUNCTION                                           *
                         *******************************************************
                         undefined do_encrypt_file()
           undefined       AL:1           &lt;RETURN&gt;
                         do_encrypt_file                                              XREF[4]:   Entry Point(*), child:001014a7(c), 001015d8, 00101718(*)  
      001010ad 0f 0b                    UD2
      001010af c5                       ??                   C5h
      001010b0 00                       ??                   00h
      001010b1 0b                       ??                   0Bh
      001010b2 01                       ??                   01h
      001010b3 00                       ??                   00h
      001010b4 00                       ??                   00h
      001010b5 78                       ??                   78h    x
      001010b6 9c                       ??                   9Ch
      001010b7 0b                       ??                   0Bh
      001010b8 f5                       ??                   F5h
      001010b9 e8                       ??                   E8h
      001010ba 7c                       ??                   7Ch    |
      001010bb ea                       ??                   EAh
      001010bc d1                       ??                   D1h
      001010bd fc                       ??                   FCh
      001010be c6                       ??                   C6h
      001010bf c0                       ??                   C0h
....
</code></pre><p>The first instruction is a <code>UD2</code> which will trigger an invalid instruction and crash the process.</p>
<p>The rest doesnt make sense&hellip; and this is where the parent &ldquo;driver&rdquo; process comes into play.</p>
<p>The parent process has attached the child process with ptrace and can catch the crash (that&rsquo;s just how debugger work by the way).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* wait for child pid */</span>
</span></span><span class="line"><span class="cl">        <span class="n">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wstatus</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* read child process registers */</span>
</span></span><span class="line"><span class="cl">        <span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_GETREGS</span><span class="p">,(</span><span class="n">ulong</span><span class="p">)</span><span class="n">pid</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">child_context</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">       <span class="cm">/* bits/waitstatus.h
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">        if (!__WIFSTOPPED(status) || (__WEXITSTATUS(status) != 4)) */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(((</span><span class="n">wstatus</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">||</span> <span class="p">(((</span><span class="kt">int</span><span class="p">)</span><span class="n">wstatus</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="o">&amp;</span> <span class="mh">0xffU</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">rip</span> <span class="o">=</span> <span class="n">child_context</span><span class="p">.</span><span class="n">rip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="cm">/* read 8 bytes of data of child data at the address pointed by child&#39;s RIP */</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_at_rip</span> <span class="o">=</span> <span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_PEEKTEXT</span><span class="p">,(</span><span class="n">ulong</span><span class="p">)</span><span class="n">pid</span><span class="p">,</span><span class="n">child_context</span><span class="p">.</span><span class="n">rip</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* check that the instruction is a UD2
</span></span></span><span class="line"><span class="cl"><span class="cm">           if not, exit
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">           0x0b0f = UD2
</span></span></span><span class="line"><span class="cl"><span class="cm">        */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="n">data_at_rip</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xb0f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* read 2 bytes at rip+2 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">compressed_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">ushort</span><span class="p">)(</span><span class="n">data_at_rip</span> <span class="o">&gt;&gt;</span> <span class="mh">0x10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="cm">/* read 2 bytes at rip + 4 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">deflate_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">ushort</span><span class="p">)(</span><span class="n">data_at_rip</span> <span class="o">&gt;&gt;</span> <span class="mh">0x20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">rip</span> <span class="o">=</span> <span class="n">rip</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="cm">/* read data in child&#39;s process starting at RIP+8 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">deflate_buffer</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="n">deflate_size</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">compressed_buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">calloc</span><span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="n">compressed_size</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">uint</span><span class="p">)</span><span class="n">compressed_size</span><span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span> <span class="o">=</span> <span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_PEEKTEXT</span><span class="p">,(</span><span class="n">ulong</span><span class="p">)</span><span class="n">pid</span><span class="p">,(</span><span class="kt">long</span><span class="p">)</span><span class="n">n</span> <span class="o">+</span> <span class="n">rip</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">compressed_buffer</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="cm">/* decompress the data */</span>
</span></span><span class="line"><span class="cl">        <span class="n">do_inflate</span><span class="p">(</span><span class="n">compressed_buffer</span><span class="p">,</span><span class="n">compressed_size</span><span class="p">,</span><span class="n">deflate_buffer</span><span class="p">,</span><span class="n">deflate_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="cm">/* write them back at original child&#39;s RIP */</span>
</span></span><span class="line"><span class="cl">        <span class="n">local_iov</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">deflate_buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">local_iov</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">size_t</span><span class="p">.</span><span class="n">conflict</span><span class="p">)</span><span class="n">deflate_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">remote_iov</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">child_context</span><span class="p">.</span><span class="n">rip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">remote_iov</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">size_t</span><span class="p">.</span><span class="n">conflict</span><span class="p">)</span><span class="n">deflate_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">res</span> <span class="o">=</span> <span class="n">process_vm_writev</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_iov</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">remote_iov</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">free</span><span class="p">(</span><span class="n">deflate_buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">free</span><span class="p">(</span><span class="n">compressed_buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* allow child to continue */</span>
</span></span><span class="line"><span class="cl">        <span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_CONT</span><span class="p">,(</span><span class="n">ulong</span><span class="p">)</span><span class="n">pid</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></div><p>So, when the child process will execute the UD2 instruction, the parent will <em>catch</em> it and will:</p>
<ul>
<li>read 8 bytes of memory at the child RIP
<ul>
<li>verify the last 2 bytes are 0xb0f
<ul>
<li>UD2 instruction&rsquo;s opcode are 0FB0 - but little endian&hellip;</li>
</ul>
</li>
<li>read the next 2 bytes as the compressed data size</li>
<li>read the next 4 bytes as the decompressed data size</li>
</ul>
</li>
<li>zlib decompress the compressed data following these 8 bytes</li>
<li>write them back to the child process using <code>process_vm_writev()</code>, starting from the crash (UD2) address
<ul>
<li>it&rsquo;s possible because of the initial call to <code>mprotect()</code> to set the text segment RWX</li>
<li>note that using <code>ptrace(PTRACE_POKEDATA)</code> instead <code>process_vm_writev()</code> doesnt require the destination address to be writable.</li>
</ul>
</li>
<li>resume child execution</li>
</ul>
<p>so basically, this is the layout of a packed function:</p>
<pre tabindex="0"><code>                         *******************************************************
                         *                                                     *
                         *  FUNCTION                                           *
                         *******************************************************
                         undefined do_encrypt_file()
           undefined       AL:1           &lt;RETURN&gt;
                         do_encrypt_file  
      001010ad 0f 0b                    UD2
      001010af c5 00                    dw                   C5h                ; = 195 / compressed size
      001010b1 0b 01 00 00              ddw                  10Bh               ; = 267 / decompressed size
                                    ; compressed data
      001010b5 78                       ??                   78h    x
      001010b6 9c                       ??                   9Ch
      001010b7 0b                       ??                   0Bh
      001010b8 f5                       ??                   F5h
</code></pre><p>The deflate is a simple zlib and if we look at the end of the <code>do_encrypt_file</code> function there&rsquo;s a bunch of NULL bytes and we can see <code>compressed size + number of null bytes + 8 == decompressed size</code>.
These 8 bytes are the size of the UD2 instructions + 2 bytes for the compressed size + 4 bytes for the uncompressed size, so we we can just overwrite the whole function code with the decompressed code (starting from 0x1010ad is this specific case.)</p>
<p>A simple ghidra script can do the deflate in place:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">#HTB inflate indefinite</span>
</span></span><span class="line"><span class="cl"><span class="c1">#@author Matthieu Walter</span>
</span></span><span class="line"><span class="cl"><span class="c1">#@category matth.ctf.htb</span>
</span></span><span class="line"><span class="cl"><span class="c1">#@keybinding</span>
</span></span><span class="line"><span class="cl"><span class="c1">#@menupath</span>
</span></span><span class="line"><span class="cl"><span class="c1">#@toolbar</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">zlib</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">jarray</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">binascii</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">decompress</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">initial_addr</span> <span class="o">=</span> <span class="n">addr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">instr</span> <span class="o">=</span> <span class="n">getShort</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">instr</span> <span class="o">!=</span> <span class="mh">0xb0f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">,</span> <span class="s2">&#34;lol&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">comp_size</span> <span class="o">=</span> <span class="n">getShort</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;comp size = </span><span class="si">%d</span><span class="s2">&#34;</span><span class="o">%</span><span class="n">comp_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">dec_size</span> <span class="o">=</span> <span class="n">getShort</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;dec size = </span><span class="si">%d</span><span class="s2">&#34;</span><span class="o">%</span><span class="n">dec_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">data_buffer</span> <span class="o">=</span> <span class="n">jarray</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">comp_size</span><span class="p">,</span><span class="s2">&#34;b&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">currentProgram</span><span class="o">.</span><span class="n">getMemory</span><span class="p">()</span><span class="o">.</span><span class="n">getBytes</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="n">data_buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">data_buffer</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">data_buffer</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">uncompressed_data</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">data_buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">addr</span> <span class="o">=</span> <span class="n">initial_addr</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">uncompressed_data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">removeDataAt</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">removeInstructionAt</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">setByte</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">addr</span> <span class="o">=</span> <span class="n">currentAddress</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">decompress</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
</span></span></code></pre></div><p>Just put the cursor on the UD2 instruction and run the script, it will do in-place decompression.</p>
<p>Then press D to decompile and  <code>do_file_encryption</code> will change from:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">do_encrypt_file</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">invalidInstructionException</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>to:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">do_encrypt_file</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">param_2</span><span class="p">,</span><span class="n">undefined8</span> <span class="n">random_8_bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">cVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">file_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">undefined8</span> <span class="o">*</span><span class="n">memory_region</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ulong</span> <span class="n">uVar2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">pcVar3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">byte</span> <span class="n">bVar4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">outputfile</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">bVar4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">outputfile</span> <span class="o">=</span> <span class="n">param_2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">param_2</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * output filename = filename.enc
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">outputfile</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">strcpy</span><span class="p">(</span><span class="n">outputfile</span><span class="p">,</span><span class="n">filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">uVar2</span> <span class="o">=</span> <span class="mh">0xffffffffffffffff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pcVar3</span> <span class="o">=</span> <span class="n">outputfile</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">uVar2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">uVar2</span> <span class="o">=</span> <span class="n">uVar2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">cVar1</span> <span class="o">=</span> <span class="o">*</span><span class="n">pcVar3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">pcVar3</span> <span class="o">=</span> <span class="n">pcVar3</span> <span class="o">+</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">bVar4</span> <span class="o">*</span> <span class="o">-</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">cVar1</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="p">(</span><span class="n">undefined4</span> <span class="o">*</span><span class="p">)(</span><span class="n">outputfile</span> <span class="o">+</span> <span class="p">(</span><span class="o">~</span><span class="n">uVar2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mh">0x636e652e</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="p">(</span><span class="n">undefined</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)(</span><span class="n">outputfile</span> <span class="o">+</span> <span class="p">(</span><span class="o">~</span><span class="n">uVar2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">file_size</span> <span class="o">=</span> <span class="n">get_filesize</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">file_size</span> <span class="o">=</span> <span class="n">file_size</span> <span class="o">+</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)((</span><span class="n">uint</span><span class="p">)</span><span class="n">file_size</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* allocate filesize + 8 bytes
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">memory_region</span> <span class="o">=</span> <span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">file_size</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* write the key to the beginning of the file
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">memory_region</span> <span class="o">=</span> <span class="n">random_8_bytes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/* read input file
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">read_file_data</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">file_size</span><span class="p">,</span><span class="n">memory_region</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* encrypt with key
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">do_encryption</span><span class="p">(</span><span class="n">file_size</span><span class="p">,</span><span class="n">memory_region</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span><span class="n">random_8_bytes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* write to output file
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">write_file_data</span><span class="p">(</span><span class="n">outputfile</span><span class="p">,</span><span class="n">file_size</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span><span class="n">memory_region</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>rinse and repeat with the other compressed functions.</p>
<p>The <code>do_encryption</code> is XORing each 8 bytes input block with the round key returned by <code>advance(key)</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">do_encryption</span><span class="p">(</span><span class="n">ulong</span> <span class="n">size</span><span class="p">,</span><span class="n">ulong</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span><span class="n">ulong</span> <span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ulong</span> <span class="n">key_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ulong</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">key_</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">key_</span> <span class="o">=</span> <span class="n">advance</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">key_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="p">(</span><span class="n">ulong</span> <span class="o">*</span><span class="p">)(</span><span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">dest</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">ulong</span> <span class="o">*</span><span class="p">)(</span><span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">dest</span><span class="p">)</span> <span class="o">^</span> <span class="n">key_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>and <code>advance</code> is based on CRC32: given an input, it returns crc32(input) concat reverse(crc32(input)).</p>
<p>ex: if crc32(n) == ABCD, it returns ABCDDCBA</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ulong</span> <span class="nf">advance</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="n">param_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ulong</span> <span class="n">uVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">byte</span> <span class="n">local_40</span> <span class="p">[</span><span class="mi">20</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">uint</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">uint</span> <span class="n">local_28</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">local_20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">local_28</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">local_28</span> <span class="o">=</span> <span class="n">local_28</span> <span class="o">^</span> <span class="n">local_40</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">local_20</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">local_20</span><span class="p">;</span> <span class="n">local_20</span> <span class="o">=</span> <span class="n">local_20</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">local_28</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">local_28</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xedb88320</span> <span class="o">^</span> <span class="n">local_28</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">uVar1</span> <span class="o">=</span> <span class="n">swap_bytes</span><span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="o">~</span><span class="n">local_28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">uVar1</span> <span class="o">|</span> <span class="o">~</span><span class="n">local_28</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>During the CTF, I did not reverse the whole thing:</p>
<p>we know that the first 8 bytes of the file are the initial key, we can just patch the file to read the key from a user controlled file instead of /dev/urandom&hellip;</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># poor man&#39;s patch ....</span>
</span></span><span class="line"><span class="cl"><span class="nb">open</span><span class="p">(</span><span class="s2">&#34;indefinite.patch&#34;</span><span class="p">,</span> <span class="s2">&#34;wb&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&#34;indefinite&#34;</span><span class="p">,</span> <span class="s2">&#34;rb&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;/dev/urandom&#34;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;keyfile_1111&#34;</span><span class="p">))</span>
</span></span></code></pre></div><p>and then</p>
<pre tabindex="0"><code># read seed from encrypted file and write it to keyfile_1111
% dd if=flag.txt.enc bs=1 count=8 of=keyfile_1111
8+0 records in
8+0 records out
8 bytes copied, 0.000346225 s, 23.1 kB/s

# read encrypted content (after the key) and write it to flag file
% dd if=flag.txt.enc bs=1 skip=8 of=flag
212+0 records in
212+0 records out
212 bytes copied, 0.000657295 s, 323 kB/s


# &#39;encrypt&#39; the file
% ./indefinite.patch flag

# profit
% cat flag.enc                
^�($����At 3730 Galactic Time, we will convene at our outpost the Phey forest, 4 miles from the Annara defense systems. Remember, the password for the bunker door is HTB{unr4v3ll1ng_th3_c0d3,unp4ck1ng_th3_s3cr3t}.
�35+��U%                                                                    
</code></pre><p>For the sake of completeness here&rsquo;s a python decoder:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">xor</span><span class="p">,</span> <span class="n">p32</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">zlib</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">BLOCK_SIZE</span> <span class="o">=</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&#34;rb&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">blocks</span><span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">BLOCK_SIZE</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">BLOCK_SIZE</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">crc</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">zlib</span><span class="o">.</span><span class="n">crc32</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">crc</span> <span class="o">+</span> <span class="n">crc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">key</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">output</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="n">advance</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">output</span> <span class="o">+=</span> <span class="n">xor</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</span></span></code></pre></div><pre tabindex="0"><code>% python dec.py flag.txt.enc
b&#39;At 3730 Galactic Time, we will convene at our outpost the Phey forest, 4 miles from the Annara defense systems. Remember, the password for the bunker door is HTB{unr4v3ll1ng_th3_c0d3,unp4ck1ng_th3_s3cr3t}.\n\xcb\x1335+\x8d\xa6tj\x18&#39;
</code></pre>
			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://matth.dmz42.org/tags/ctf">ctf</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>5876 Words</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2022-05-21 21:15 &#43;0200</p>
			</footer>
		</article>
		<aside id="toc">
			<div class="toc-title">Table of Contents</div>
			<nav id="TableOfContents">
  <ul>
    <li><a href="#71-gocheck">7.1 GoCheck</a></li>
    <li><a href="#72-rust_check">7.2 rust_check</a></li>
    <li><a href="#73-python_check">7.3 python_check</a></li>
    <li><a href="#74-java_check">7.4 java_check</a></li>
  </ul>
</nav>
		</aside>
		<div class="post-nav thin">
			<a class="next-post" href="https://matth.dmz42.org/posts/2022/automatically-unpacking-icedid-stage1-with-angr/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;Newer</span><br><span>Automatically Unpacking IcedID Stage 1 with angr</span>
			</a>
			<a class="prev-post" href="https://matth.dmz42.org/posts/2022/hackthebox-ctf-cyber-apocalypse-2022-intergalactic-chase-pwn/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>HackTheBox CTF Cyber Apocalypse 2022: Intergalactic Chase (PWN)</span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2022 <a href="https://matth.dmz42.org">Matthieu Walter</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://matth.dmz42.org/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>



	<script src="https://matth.dmz42.org/js/bundle.min.580988ed2982bcbb74a1773c7abea97b43e4c43b9324e10cda0813ec6ec4bb67.js" integrity="sha256-WAmI7SmCvLt0oXc8er6pe0PkxDuTJOEM2ggT7G7Eu2c=" crossorigin="anonymous"></script>
	

</body>

</html>
