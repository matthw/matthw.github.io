<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="The Return of the Malwarebytes Crackme">
<meta itemprop="description" content="Malwarebytes released their 3rd crackme, here&rsquo;s my entry for the writeup contest.
You can find the original announcement here and the contest summary here.
0. First Look Running the crackme, we understand we&rsquo;ll be asked to find 3 passwords. Only the first button is enabled, so they will most likely need to be found in order
Loading the binary into PE-bear reveals it&rsquo;s a Dot Net binary
so let&rsquo;s open it in dnSpy"><meta itemprop="datePublished" content="2021-11-08T14:20:47+01:00" />
<meta itemprop="dateModified" content="2021-11-08T14:20:47+01:00" />
<meta itemprop="wordCount" content="6267">
<meta itemprop="keywords" content="reverse,malware,crackme,writeup," /><meta property="og:title" content="The Return of the Malwarebytes Crackme" />
<meta property="og:description" content="Malwarebytes released their 3rd crackme, here&rsquo;s my entry for the writeup contest.
You can find the original announcement here and the contest summary here.
0. First Look Running the crackme, we understand we&rsquo;ll be asked to find 3 passwords. Only the first button is enabled, so they will most likely need to be found in order
Loading the binary into PE-bear reveals it&rsquo;s a Dot Net binary
so let&rsquo;s open it in dnSpy" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://matth.dmz42.org/posts/2021/the-return-of-the-malwarebytes-crackme/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-08T14:20:47+01:00" />
<meta property="article:modified_time" content="2021-11-08T14:20:47+01:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="The Return of the Malwarebytes Crackme"/>
<meta name="twitter:description" content="Malwarebytes released their 3rd crackme, here&rsquo;s my entry for the writeup contest.
You can find the original announcement here and the contest summary here.
0. First Look Running the crackme, we understand we&rsquo;ll be asked to find 3 passwords. Only the first button is enabled, so they will most likely need to be found in order
Loading the binary into PE-bear reveals it&rsquo;s a Dot Net binary
so let&rsquo;s open it in dnSpy"/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>The Return of the Malwarebytes Crackme</title>
	<link rel="stylesheet" href="https://matth.dmz42.org/css/style.min.037b6ee8f8c1baab6a3d0a9da11c3ff18a7552471f16c59fd98538d5ce99208b.css" integrity="sha256-A3tu6PjBuqtqPQqdoRw/8Yp1UkcfFsWf2YU41c6ZIIs=" crossorigin="anonymous">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://matth.dmz42.org"># matth.dmz42.org</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://matth.dmz42.org/posts/">Posts</a>
				<a href="https://matth.dmz42.org/tags/">Tags</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<span class="hdr-social hide-in-mobile"><a href="https://twitter.com/matth_walter" target="_blank" rel="noopener me" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://github.com/matthw" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a><a href="https://www.linkedin.com/in/mwalter/" target="_blank" rel="noopener me" title="Linkedin"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://matth.dmz42.org/posts/">Posts</a></li>
			<li><a href="https://matth.dmz42.org/tags/">Tags</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Nov 8, 2021</span></div>
				<h1>The Return of the Malwarebytes Crackme</h1>
			</header>
			<div class="content">
				<p>Malwarebytes released their 3rd crackme, here&rsquo;s my entry for the writeup contest.<br>
You can find the original announcement <a href="https://matth.dmz42.org/posts/2021/the-return-of-the-malwarebytes-crackme/">here</a> and the contest summary <a href="https://blog.malwarebytes.com/threat-intelligence/2021/11/malwarebytes-crackme-contest-summary/">here</a>.</p>
<h2 id="0-first-look">0. First Look<a href="#0-first-look" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>Running the crackme, we understand we&rsquo;ll be asked to find 3 passwords.
Only the first button is enabled, so they will most likely need to be found in order</p>
<p><img src="01-mainscreen.png" alt="Main Screen"></p>
<p>Loading the binary into PE-bear reveals it&rsquo;s a Dot Net binary</p>
<p><img src="02-pebear.png" alt="PE-bear"></p>
<p>so let&rsquo;s open it in dnSpy</p>
<p><img src="03-dnspy.png" alt="dnSpy"></p>
<p>It opens nicely, so far, so good.</p>
<h2 id="1-level-1">1. Level 1<a href="#1-level-1" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>Browsing a little bit in dnSpy we quickly find the code behind the 3 buttons, so let&rsquo;s start with the first one:
<img src="10-l1-button.png" alt="button 1 action">
<img src="11-l1-vars.png" alt="variables"></p>
<p>It&rsquo;s basically calling a <code>decode</code> function with a resource named <code>mb_logo_star</code> as first parameter and our input password as 2nd parameter.
The resulting array is then resized to <strong>241152</strong> bytes and if its crc32 is <strong>2741486452</strong> the bytes are written to  <code>%TEMP%/level2.exe</code> and the newly created binary is executed.</p>
<p>It&rsquo;s safe to assume the <code>decode</code> function will use our input password to somehow decrypt an executable.</p>
<p>Let&rsquo;s start by extracting the resource, which is easily done with dnSpy:</p>
<p><img src="12-l1-save_img.png" alt="extract image"></p>
<p>and look at the <code>decode</code> function</p>
<p><img src="13-l1-decode.png" alt="decode function"></p>
<p>it uses LSB (Least Significant Bits) steganography to hide data:</p>
<ul>
<li>each pixel is represented by 3 color bytes Red, Green and Blue</li>
<li>the least 3 significant bits of the red and green values, and the 2 least significant bits of the blue are used to encode a total of 8bits per pixel</li>
<li>the resulting byte is then XOR&rsquo;d with our input password</li>
</ul>
<p>let&rsquo;s start by extracting the data with a simple script:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">bm</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&#34;mb_logo_star&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;l1_extract.bin&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bm</span><span class="o">.</span><span class="n">width</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bm</span><span class="o">.</span><span class="n">height</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">bm</span><span class="o">.</span><span class="n">getpixel</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">num2</span> <span class="o">=</span> <span class="n">r</span> <span class="o">&amp;</span> <span class="mi">7</span>
</span></span><span class="line"><span class="cl">            <span class="n">num3</span> <span class="o">=</span> <span class="p">(</span><span class="n">g</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">            <span class="n">num4</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span>
</span></span><span class="line"><span class="cl">            <span class="n">b</span> <span class="o">=</span> <span class="n">num2</span> <span class="o">|</span> <span class="n">num3</span> <span class="o">|</span> <span class="n">num4</span>
</span></span><span class="line"><span class="cl">            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">))</span>
</span></span></code></pre></div><p>One thing with PE files, is that they contain quite a lot of contiguous NULL bytes, which if we are lucky could reveal the XOR key straight away</p>
<pre tabindex="0"><code>% xxd l1_extract.bin| more
[snip]
00000270: 845e 6b65 65a0 5c67 6f6b 6e67 21f9 6273  .^kee.\gokng!.bs
00000280: 795f 6c65 7665 6c5f 6f6e 655f 216c 6d2f  y_level_one_!lm/
00000290: 5d06 3a08 000d 655f 6061 725f 7085 5c61  ].:...e_`ar_p.\a
000002a0: 6e74 5f6b 65fb 735f 676f 696e 6721 6561  nt_ke.s_going!ea
000002b0: 7379 5f6c 2576 652e 5f6f 6e65 5f61 6c6d  sy_l%ve._one_alm
000002c0: 6f73 745f 646f 6e65 5f78 6f72 5f70 655f  ost_done_xor_pe_
000002d0: 616e 645f 6b65 6570 5f67 6f69 6e67 2165  and_keep_going!e
000002e0: 6173 795f 6c65 7665 6c5f 6f6e 655f 616c  asy_level_one_al
000002f0: 6d6f 7374 5f64 6f6e 655f 786f 725f 7065  most_done_xor_pe
00000300: 5f61 6e64 5f6b 6565 705f 676f 696e 6721  _and_keep_going!
00000310: 6561 7379 5f6c 6576 656c 5f6f 6e65 5f61  easy_level_one_a
00000320: 6c6d 6f73 745f 646f 6e65 5f78 6f72 5f70  lmost_done_xor_p
00000330: 655f 616e 645f 6b65 6570 5f67 6f69 6e67  e_and_keep_going
00000340: 2165 6173 795f 6c65 7665 6c5f 6f6e 655f  !easy_level_one_
00000350: 616c 6d6f 7374 5f64 6f6e 655f 786f 725f  almost_done_xor_
00000360: 7065 5f61 6e64 5f6b 6565 705f 676f 696e  pe_and_keep_goin
00000370: 6721 6561 7379 5f6c 6576 656c 5f6f 6e65  g!easy_level_one
00000380: 5f61 6c6d 6f73 745f 646f 6e65 5f78 6f72  _almost_done_xor
00000390: 5f70 655f 616e 645f 6b65 6570 5f67 6f69  _pe_and_keep_goi
000003a0: 6e67 2165 6173 795f 6c65 7665 6c5f 6f6e  ng!easy_level_on
000003b0: 655f 616c 6d6f 7374 5f64 6f6e 655f 786f  e_almost_done_xo
000003c0: 725f 7065 5f61 6e64 5f6b 6565 705f 676f  r_pe_and_keep_go
000003d0: 696e 6721 6561 7379 5f6c 6576 656c 5f6f  ing!easy_level_o
000003e0: 6e65 5f61 6c6d 6f73 745f 646f 6e65 5f78  ne_almost_done_x
000003f0: 6f72 5f70 655f 616e 645f 6b65 6570 5f67  or_pe_and_keep_g
00000400: 3ae2 82ec 646d 37f8 79d4 64ee 0669 eda6  :...dm7.y.d..i..
00000410: 6a6e 659f 1470 076f 1b14 be24 6f06 0dbe  jne..p.o...$o...
</code></pre><p>it&rsquo;s easy to notice the repeating string: <strong>easy_level_one_almost_done_xor_pe_and_keep_going!</strong></p>
<p>which turns out to be the correct key:</p>
<p><img src="14-l1-correct.png" alt="level1"></p>
<h2 id="2-level-2">2. Level 2<a href="#2-level-2" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>We can confirm that the crackme spawned a new process (in this case with <code>procmon</code> from the <a href="https://docs.microsoft.com/en-us/sysinternals/">sysinternals suite</a>):</p>
<p><img src="20-l2-proc_level2.exe.png" alt="new process"></p>
<p>At this stage if we input some random password for level2, we get an error and the crackme exits</p>
<p><img src="21-l2-antidebug.png" alt="anti debug"></p>
<p>We can suspect it&rsquo;s because of procmon running: if we retry when it&rsquo;s not running, it does not happen.</p>
<p>The only way to know for sure is to take a look at this <strong>level2.exe</strong>, but first let&rsquo;s have a look at the action performed when we click the 2nd button of the crackme:</p>
<p><img src="23-l2_button2.png" alt="button 2 click"></p>
<p>it tries to connect to named pipe <code>crackme_pipe</code>, then writes our input password to it, reads something back, checks the CRC, and if it matches an expected value, calls <code>LoadNext.load(level2.exe_process, what_was_read_from_the_pipe)</code></p>
<p><code>LoadNext.Load()</code> will use the data read from the pipe to decrypt and load a Dot Net assembly:</p>
<p><img src="23-l2_button2_loadnext.png" alt="LoadNext"></p>
<p>and then call the <code>RunMe.Invoke(instance, level2.exe_process)</code> - most likely injecting code in the level2.exe process.</p>
<p>the key and IV are derived from the SHA256 hash of the password supplied to <code>AES.decryptContent</code>:</p>
<p><img src="23-l2_button2_decrypt.png" alt="AES decrypt"></p>
<p>We can assume the flow for level2 is:</p>
<ol>
<li><strong>frontend:</strong>   write input_password to pipe</li>
<li><strong>level2.exe:</strong> read input_password from pipe, do <em>something</em> and write something back to the pipe</li>
<li><strong>frontend:</strong> read <em>something</em> from the pipe</li>
<li><strong>frontend:</strong> derive AES IV and key from what was read from the pipe</li>
<li><strong>frontend:</strong> decrypt a Dot NET assembly</li>
<li><strong>frontend:</strong> probably do some code injection of some sort ?</li>
</ol>
<p>Time to look at <code>level2.exe</code>, we should find some code related to named pipes for sure.</p>
<h3 id="21-exploring-level2exe">2.1 Exploring level2.exe<a href="#21-exploring-level2exe" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>We can either XOR the content we extracted from the image with the password #1 and trim it to the correct size, or just copy the executable from %TEMP% - both work, but the second is a lesser effort.</p>
<p><img src="22-l2-temp_level2.png" alt="temp exec path"></p>
<p>This time it&rsquo;s not a Dot NET binary, so let&rsquo;s open it with our favorite disassembler/decompiler.
From the entry point, we can navigate down to the main function, which roughly look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main_0</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="nc">_PEB</span> <span class="o">*</span><span class="n">v4</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_DWORD</span> <span class="o">*</span><span class="n">v5</span><span class="p">;</span> <span class="c1">// ecx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v7</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">size_t</span> <span class="n">v8</span><span class="p">;</span> <span class="c1">// esi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="p">(</span><span class="kr">__stdcall</span> <span class="o">*</span><span class="n">function_pointer</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="p">,</span> <span class="n">_DWORD</span><span class="p">,</span> <span class="n">size_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v10</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">v11</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span> <span class="c1">// ecx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">size_t</span> <span class="n">v12</span><span class="p">;</span> <span class="c1">// [esp+8h] [ebp-4E4C0h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span> <span class="o">*</span><span class="n">v13</span><span class="p">;</span> <span class="c1">// [esp+Ch] [ebp-4E4BCh] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">320692</span><span class="p">];</span> <span class="c1">// [esp+10h] [ebp-4E4B8h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// register a Vectored Exception Handler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">AddVectoredExceptionHandler</span><span class="p">(</span><span class="mi">1u</span><span class="p">,</span> <span class="n">Handler</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// do something with a buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x4E4B2u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">sub_4011D0</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unk_414000</span><span class="p">,</span> <span class="mi">160345</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">320690</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Size</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">  <span class="c1">// direct access to the PEB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">v4</span> <span class="o">=</span> <span class="n">NtCurrentPeb</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">v5</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">v4</span><span class="o">-&gt;</span><span class="n">ImageBaseAddress</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="n">v5</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v6</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v5</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v5</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v5</span> <span class="o">=</span> <span class="o">*</span><span class="n">v5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">++</span><span class="n">v6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span> <span class="o">!</span><span class="n">v6</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v7</span> <span class="o">=</span> <span class="n">v5</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">v8</span> <span class="o">=</span> <span class="n">Size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// somehow get a function pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span> <span class="n">v7</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">function_pointer</span> <span class="o">=</span> <span class="n">sub_401250</span><span class="p">(</span><span class="n">v7</span><span class="p">,</span> <span class="mh">0xF4DD3DAD</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">v13</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v12</span> <span class="o">=</span> <span class="n">v8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// execute this function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">v10</span> <span class="o">=</span> <span class="n">function_pointer</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v13</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v12</span><span class="p">,</span> <span class="mi">1060864</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">v11</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v10</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">v11</span> <span class="o">=</span> <span class="n">v13</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dword_43BAE0</span> <span class="o">=</span> <span class="n">v11</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">v11</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// copy &#34;buffer&#34; somewhere else
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">memmove</span><span class="p">(</span><span class="n">v11</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">Size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// and execute it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">dword_43BAE0</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">dword_43BAE0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>At first glance there&rsquo;s nothing much involving some sort of password checking or named pipe operation, however a few things stand out straight away:</p>
<ul>
<li>
<p>it registers a Vectored Exception Handler (VEH) via the <code>AddVectoredExceptionHandler(1, Handler)</code> call</p>
<ul>
<li>SEH/VEH can be used to obfuscate control flow (luckily there&rsquo;s no such thing here - we&rsquo;ll see what it is used for later on).</li>
</ul>
</li>
<li>
<p>it is directly accessing the PEB (Process Environment Block)</p>
<ul>
<li>PEB via FS:[0x30] and then _PEB_LDR_DATA via PEB+0xC</li>
<li>probably to get a list of loaded DLLs</li>
</ul>
</li>
</ul>
<p><img src="60-peb.jpg" alt="PEB"></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">  <span class="c1">// direct access to the PEB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">v4</span> <span class="o">=</span> <span class="n">NtCurrentPeb</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">v5</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">v4</span><span class="o">-&gt;</span><span class="n">ImageBaseAddress</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="n">v5</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v6</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v5</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v5</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v5</span> <span class="o">=</span> <span class="o">*</span><span class="n">v5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">++</span><span class="n">v6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span> <span class="o">!</span><span class="n">v6</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v7</span> <span class="o">=</span> <span class="n">v5</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
</span></span></code></pre></div><ul>
<li>it is dynamically getting a function pointer, based on a value which look like a hash</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">  <span class="c1">// somehow get a function pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span> <span class="n">v7</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">function_pointer</span> <span class="o">=</span> <span class="n">sub_401250</span><span class="p">(</span><span class="n">v7</span><span class="p">,</span> <span class="mh">0xF4DD3DAD</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">v13</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v12</span> <span class="o">=</span> <span class="n">v8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// execute this function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">v10</span> <span class="o">=</span> <span class="n">function_pointer</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v13</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v12</span><span class="p">,</span> <span class="mi">1060864</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
</span></span></code></pre></div><ul>
<li>it&rsquo;s transfering execution into memory</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">   <span class="n">dword_43BAE0</span> <span class="o">=</span> <span class="n">v11</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">v11</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// copy &#34;buffer&#34; somewhere else
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">memmove</span><span class="p">(</span><span class="n">v11</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">Size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// and execute it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">dword_43BAE0</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></div><p>So it seems that it is using API hashing, a technique commonly used in malware to obfuscate API calls in order to unpack a second stage payload and transfert excution to it.
Let&rsquo;s dive into both.</p>
<h3 id="22-api-hashing">2.2 API Hashing<a href="#22-api-hashing" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>API hashing is a common and pretty well documented technique, which dynamically resolves API functions.
As a result instead of directly calling:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">CreateThread</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">);</span>
</span></span></code></pre></div><p>one would do something like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">ptr_CreateThread</span> <span class="o">=</span> <span class="n">get_func_by_hash</span><span class="p">(</span><span class="n">kernel32</span><span class="p">.</span><span class="n">dll</span><span class="p">,</span> <span class="mh">0x11fc85fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">ptr_CreateThread</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">);</span>
</span></span></code></pre></div><p>with <code>0x11fc85fd</code> being a precalculated hash value of some sort for the string &ldquo;CreateThread&rdquo;.</p>
<p>I will not go into greater details of the internals of this technique as i am not the most skilled person to do so and would probably give incorrect information. It is also pretty well documented all over the internet, but basically, and i hope i am not already giving wrong information:</p>
<ol>
<li>access the PEB from where</li>
<li>get a list of loaded dll with their base address</li>
<li>from the base dll address, it can loop over the dll exports list</li>
<li>for each export, calculate the hash of the name</li>
<li>if this hash matches the hash we&rsquo;re looking for, returns the address of the function</li>
</ol>
<p>references:</p>
<ul>
<li><a href="https://0xevilc0de.com/locating-dll-name-from-the-process-environment-block-peb/">https://0xevilc0de.com/locating-dll-name-from-the-process-environment-block-peb/</a></li>
<li><a href="https://www.ired.team/offensive-security/code-injection-process-injection/finding-kernel32-base-and-function-addresses-in-shellcode">https://www.ired.team/offensive-security/code-injection-process-injection/finding-kernel32-base-and-function-addresses-in-shellcode</a></li>
</ul>
<p>It&rsquo;s fair to say it makes static analysis more complicated.</p>
<p>From here we could reverse the hashing algorithm and apply it to all exports of common DLLs.
That would give us a list of common API funtions with their hash and an easy way to find a function name from its hash.</p>
<p>This is for example what <a href="https://github.com/mandiant/flare-ida">FLARE-IDA</a> is doing with <code>shellcode_hashes</code>. It&rsquo;s great if there&rsquo;s a lot of such obfuscated calls (note that you don&rsquo;t <em>need</em> IDA to use it, you can just directly query the sqlite db).</p>
<p>The function hashing algorithm used here looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">func_hash</span><span class="p">(</span><span class="n">func_name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">h</span> <span class="o">=</span> <span class="mh">0xf00df00d</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">func_name</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">h</span> <span class="o">=</span> <span class="p">((</span><span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">h</span> <span class="o">&gt;&gt;</span> <span class="mh">0x1b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">h</span>
</span></span></code></pre></div><p>In our case, there&rsquo;s only a pair of such calls, so we can just go with dynamic analysis instead.</p>
<p>Inside this function:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">  <span class="c1">// do something with a buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">sub_4011D0</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unk_414000</span><span class="p">,</span> <span class="mi">160345</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">320690</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Size</span><span class="p">)</span> <span class="p">)</span>
</span></span></code></pre></div><p>there&rsquo;s such call:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">   <span class="n">function_pointer</span> <span class="o">=</span> <span class="n">get_function_by_hash</span><span class="p">(</span><span class="n">v8</span><span class="p">,</span> <span class="mh">0x3AC473D1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">function_pointer</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">function_pointer</span><span class="p">(</span><span class="mi">258</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a5</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></div><p><img src="24-l2-call_eax_01.png" alt="call eax 1"></p>
<p>and inside the main function as first identified:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"> <span class="c1">// somehow get a function pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span> <span class="n">v7</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">function_pointer</span> <span class="o">=</span> <span class="n">get_function_by_hash</span><span class="p">(</span><span class="n">v7</span><span class="p">,</span> <span class="mh">0xF4DD3DAD</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">v13</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v12</span> <span class="o">=</span> <span class="n">v8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// execute this function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">v10</span> <span class="o">=</span> <span class="n">function_pointer</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v13</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v12</span><span class="p">,</span> <span class="mh">0x103000</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
</span></span></code></pre></div><p><img src="24-l2-call_eax_02.png" alt="call eax 2"></p>
<p>So let&rsquo;s run <code>level2.exe</code> in x32dbg and hope we&rsquo;ll not get caught by some antidebug trick at this stage.
The goal is here is to break after the calls to <code>get_func_by_hash</code> and examine EAX, which should contain the address of the resolved API function.</p>
<p>The first call resolves to <code>RtlDecompressBuffer</code></p>
<p><img src="25-l2-resolved_call_1.png" alt="first call"></p>
<p>The 2nd call to <code>NtAllocateVirtualMemory</code></p>
<p><img src="25-l2-resolved_call_2.png" alt="second call"></p>
<p>We can even verify our reversed hash function:</p>
<pre tabindex="0"><code>&gt;&gt;&gt; hex(func_hash(&#34;RtlDecompressBuffer&#34;))
&#39;0x3ac473d1&#39;
&gt;&gt;&gt; hex(func_hash(&#34;NtAllocateVirtualMemory&#34;))
&#39;0xf4dd3dad&#39;
</code></pre><p>If we put all the pieces together, the main function:</p>
<ul>
<li>decompresses a buffer</li>
<li>reserves a new memory region with RWX permissions (0x40)</li>
<li>copies the uncompress buffer to this region</li>
<li>transfers execution in there</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">  <span class="n">memset</span><span class="p">(</span><span class="n">UncompressedBuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">320690u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">decompress_buffer</span><span class="p">(</span><span class="n">CompressedBuffer</span><span class="p">,</span> <span class="mi">160345</span><span class="p">,</span> <span class="n">UncompressedBuffer</span><span class="p">,</span> <span class="mi">320690</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">FinalUncompressedSize</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">[...]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">NtAllocateVirtualMemory</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shellcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">FinalUncompressedSize</span><span class="p">,</span> <span class="mh">0x103000</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">memmove</span><span class="p">(</span><span class="n">shellcode</span><span class="p">,</span> <span class="n">UncompressedBuffer</span><span class="p">,</span> <span class="n">FinalUncompressedSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">shellcode</span><span class="p">();</span>
</span></span></code></pre></div><h3 id="23-unpacking-the-2nd-stage">2.3 Unpacking the 2nd stage<a href="#23-unpacking-the-2nd-stage" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>In order to unpack the second stage, we can break right before the control flow is transfered to the shellcode:</p>
<p><img src="26-l2-break_at_shellcode_exec.png" alt="break at shellcode"></p>
<p>if we inspect the memory at <code>shellcode</code> address, we notice that it starts with the magic <code>MZ</code> bytes and that there&rsquo;s something which looks like a DOS stub, so it seems we&rsquo;re getting a another PE file.</p>
<p>From here we can right click on the shellcode address, select <code>follow in memory map</code></p>
<p><img src="27-l2-follow_in_memory_map.png" alt="follow in memory map">
then <code>dump memory to file</code></p>
<p><img src="28-l2-dump_to_file.png" alt="dump to file"></p>
<p>The resulting file seems to be a valid PE:</p>
<p><img src="29-l2_dumped_pe.png" alt="dumped PE file"></p>
<h3 id="24-bonus-pe-to-shellcode">2.4 Bonus: PE to Shellcode<a href="#24-bonus-pe-to-shellcode" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>It&rsquo;s interesting to note that the 2nd stage payload we dumped is a PE file, however execution is directly transfered to it, like it would be with a shellcode, not with a PE.</p>
<p>It is normally not possible because a PE file must first go through a loader which will map memory, apply relocations etc&hellip; the executable code is not starting at offset 0.</p>
<p>However the PE header have been modified so it can actually be executed.
The <code>CALL EBX</code> jumps to a piece of code handling the relocations before transfering execution to the original PE entry point:</p>
<p><img src="31-l2-modified_pe_header.png" alt="modified pe header"></p>
<p>as compared to a normal PE header:</p>
<p><img src="30-l2-typical_pe_header.png" alt="typical pe header"></p>
<p>I suspect it&rsquo;s the work of Hasherezade&rsquo;s <a href="https://github.com/hasherezade/pe_to_shellcode">PE to Shellcode</a>, the loader looks similar to <a href="https://github.com/hasherezade/pe_to_shellcode/blob/master/hldr32/hldr32.asm">this</a>.
Pretty neat trick.</p>
<h3 id="25-analyzing-the-2nd-stage">2.5 Analyzing the 2nd stage<a href="#25-analyzing-the-2nd-stage" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>Let&rsquo;s now have a look at the dumped content.
<em>I will only mostly use already cleaned code from here.</em></p>
<p>Again we can navigate from the entry point down to the main function:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="o">*</span><span class="n">v3</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span> <span class="o">*</span><span class="n">dbg_check</span><span class="p">;</span> <span class="c1">// edi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// esi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v3</span> <span class="o">=</span> <span class="k">operator</span> <span class="k">new</span><span class="p">(</span><span class="mi">1u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">dbg_check</span> <span class="o">=</span> <span class="n">initialize_hashes_and_check_for_debugger</span><span class="p">(</span><span class="n">v3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="n">dbg_check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">dbg_check</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v6</span> <span class="o">=</span> <span class="n">stage2_and_3_lets_go</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">pipe</span><span class="se">\\</span><span class="s">crackme_pipe&#34;</span><span class="p">,</span> <span class="mi">1337</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">__free</span><span class="p">(</span><span class="n">dbg_check</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">v6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Seeing the string <code>&quot;\\\\.\\pipe\\crackme_pipe&quot;</code> we know we&rsquo;re on the right track, but let&rsquo;s start with the first function call</p>
<h3 id="26-anti-debug">2.6 Anti debug<a href="#26-anti-debug" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>The first function is responsible for initializing a list of hashes and performing some antidebug checks:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span><span class="n">__thiscall</span> <span class="nf">initialize_hashes_and_check_for_debugger</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="k">this</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">table_pointer</span><span class="p">;</span> <span class="c1">// esi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">table_size</span><span class="p">;</span> <span class="c1">// edi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span> <span class="o">*</span><span class="n">v4</span><span class="p">;</span> <span class="c1">// ecx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">v6</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span> <span class="c1">// [esp+Ch] [ebp-98h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span> <span class="o">*</span><span class="n">_this</span><span class="p">;</span> <span class="c1">// [esp+14h] [ebp-90h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">process_hash</span><span class="p">[</span><span class="mi">34</span><span class="p">];</span> <span class="c1">// [esp+18h] [ebp-8Ch] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">table_pointer</span> <span class="o">=</span> <span class="n">process_hash</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="n">table_size</span> <span class="o">=</span> <span class="mi">34</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xC81D63C9</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5B2839AC</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x17DAD73F</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x72C7241C</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x58E483ED</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x82134662</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x34204667</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4CD53A71</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x34206499</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFDEB191</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7AC6410B</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xEA3503AA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xCCFA2924</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3A09FFBC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x38EA0C1B</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x58E479EC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1B964E1A</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x707F9D9A</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF5A79701</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x9F5473B</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xBA635AC6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xBB18A65</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x46119FD8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFB7BF6AF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3F75D54B</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x49110E9F</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5D9F9FD8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5DCC9FD8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8293C33E</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5D112314</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x9D9F8189</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xC10AE786</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x67D8B725</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7FE9020</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">initialize_hash_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_HASH_SET</span><span class="p">,</span> <span class="n">v6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">table_pointer</span><span class="o">++</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">--</span><span class="n">table_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span> <span class="n">table_size</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">check_for_debuggers</span><span class="p">(</span><span class="n">v4</span><span class="p">)</span> <span class="o">||</span> <span class="n">kernel_mode_antidbg</span><span class="p">()</span> <span class="o">||</span> <span class="n">enumerate_process_and_hash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_HASH_SET</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">__debugbreak</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">_this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>after the initization of a global hashes set, it will call 3 functions:</p>
<h4 id="261-check_for_debuggers">2.6.1 check_for_debuggers()<a href="#261-check_for_debuggers" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>this function uses the following API functions to check if the process is being debugged:</p>
<ul>
<li><code>IsDebuggerPresent()</code></li>
<li><code>CheckRemoteDebuggerPresent(GetCurrentProcess(), &amp;pbDebuggerPresent);</code></li>
</ul>
<h4 id="262-kernel_mode_antidbg">2.6.2 kernel_mode_antidbg()<a href="#262-kernel_mode_antidbg" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>this function checks for a kernel debugger using</p>
<p><code>IsBadReadPtr(0x7FFE0000, 0x3B8u);</code></p>
<p>more info here: <a href="https://github.com/hasherezade/antianalysis_demos/blob/master/kernelmode_antidbg.cpp">https://github.com/hasherezade/antianalysis_demos/blob/master/kernelmode_antidbg.cpp</a></p>
<h4 id="263-enumerate_process_and_hash">2.6.3 enumerate_process_and_hash()<a href="#263-enumerate_process_and_hash" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>This function takes 2 parameters: the list of hashes previously initialized and a bool.
It&rsquo;s using the combo <code>CreateToolhelp32Snapshot()</code>, <code>Process32First()</code>, <code>Process32Next()</code> to iterate over the list of running processes.</p>
<p>For each process, it gets the executable name, strips the trailing &ldquo;.exe&rdquo;, computes a hash and checks if the hash is part of the previously initialized list.</p>
<p>Since the bool parameter we mentionned earlier is set to 1, the hash is computed on the lower case version of the executable name (making it case insensitive).</p>
<p>The hash is calculated in this way:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">hash</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="mh">0xbadc0ffe</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span> <span class="o">=</span> <span class="p">((</span><span class="n">key</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">key</span> <span class="o">&gt;&gt;</span> <span class="mh">0x1b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">key</span>
</span></span></code></pre></div><p>we remember that if <code>procmon</code> was running the crackme detected it, so let&rsquo;s perform a quick check:</p>
<pre tabindex="0"><code>&gt;&gt;&gt; hex(hash(&#34;procmon&#34;))
&#39;0x34204667&#39;
</code></pre><p>we can indeed find this hash in the in list:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">process_hash</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x34204667</span><span class="p">;</span>                 <span class="c1">// procmon
</span></span></span></code></pre></div><p>So far so good&hellip; we&rsquo;ll come back to these hashes later on.</p>
<h4 id="264-handling">2.6.4 Handling<a href="#264-handling" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>If any of these checks fail, the binary will call <code>__debugbreak()</code> - generating a software breakpoint which will either be caught by the debugger - if any and be harmless, or by the Vectored Exception Handler registered before the unpacking of the 2nd stage.</p>
<p>The handler looks like this, and will exit the process with -1 in case there&rsquo;s a (uncaught) breakpoint happening within the stage 2 payload:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">LONG</span> <span class="kr">__stdcall</span> <span class="nf">Handler</span><span class="p">(</span><span class="k">struct</span> <span class="nc">_EXCEPTION_POINTERS</span> <span class="o">*</span><span class="n">ExceptionInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">DWORD</span> <span class="n">exception_code</span><span class="p">;</span> <span class="c1">// ecx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">exception_address</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span> <span class="c1">// esi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">exception_code</span> <span class="o">=</span> <span class="n">ExceptionInfo</span><span class="o">-&gt;</span><span class="n">ExceptionRecord</span><span class="o">-&gt;</span><span class="n">ExceptionCode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">exception_address</span> <span class="o">=</span> <span class="n">ExceptionInfo</span><span class="o">-&gt;</span><span class="n">ExceptionRecord</span><span class="o">-&gt;</span><span class="n">ExceptionAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// // access violation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span> <span class="n">exception_code</span> <span class="o">==</span> <span class="mh">0xC0000005</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">MessageBoxA</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#34;Failed!&#34;</span><span class="p">,</span> <span class="s">&#34;ERROR&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ExitProcess</span><span class="p">(</span><span class="o">-</span><span class="mi">2u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// exception happened when executing the shellcode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// and the code was 0x80000003 (breakpoint)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span> <span class="n">shellcode</span>
</span></span><span class="line"><span class="cl">    <span class="o">&amp;&amp;</span> <span class="n">FinalUncompressedSize</span>
</span></span><span class="line"><span class="cl">    <span class="o">&amp;&amp;</span> <span class="n">exception_address</span> <span class="o">&gt;=</span> <span class="n">shellcode</span>
</span></span><span class="line"><span class="cl">    <span class="o">&amp;&amp;</span> <span class="n">exception_address</span> <span class="o">&lt;</span> <span class="n">shellcode</span> <span class="o">+</span> <span class="n">FinalUncompressedSize</span>
</span></span><span class="line"><span class="cl">    <span class="o">&amp;&amp;</span> <span class="n">exception_code</span> <span class="o">==</span> <span class="mh">0x80000003</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ExitProcess</span><span class="p">(</span><span class="o">-</span><span class="mi">1u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>If the program exits with -1, the frontend will catch it and display the popup we&rsquo;ve seen earlier about analysis tools:</p>
<p><img src="29-l2-exit_code_check.jpg" alt="anti analysis tools"></p>
<h3 id="27-bypassing-the-anti-debug">2.7 Bypassing the Anti debug<a href="#27-bypassing-the-anti-debug" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>There might be different ways to bypass these checks, among them:</p>
<ul>
<li>The first (two ?) checks can be bypassed using a x64dbg plugin like <code>ScyllaHide</code></li>
<li>The last one can be circumvent by renaming our analysis tools executables.</li>
<li>One could also use x64dbg to patch the checks (NOP them or make them always successfull), or manipulate registers/flags to achieve the same result, but i do not think this would be really practical as the shellcode will be loaded at a different address everytime and most likely the checks would have run already before we have a chance to attach it.</li>
<li>Maybe the VEH in level2.exe could be patched to do nothing instead of exiting ?</li>
</ul>
<p>To be honest, I did not try any of these because the checks are only run once after the second stage payload is executed, meaning we can just start our analysis tools after entering the 1st password and waiting a few millisec for level2.exe to kick in&hellip;</p>
<p>This is what i found the easiest and most practical for me here:</p>
<ol>
<li>start the crackme</li>
<li>enter the 1st password</li>
<li>start the debugger and attach to level2.exe</li>
<li>profit!</li>
</ol>
<p>After the 2nd step, the debug checks are not called again and we can freely play, no need to make it more complex than it needs to be.</p>
<h3 id="28-core-business">2.8 Core business<a href="#28-core-business" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>Let&rsquo;s continue the exploration and look at the <code>stage2_and_3_lets_go(&quot;\\\\.\\pipe\\crackme_pipe&quot;, 1337)</code> function.</p>
<p>It starts 2 threads: one for level2 and one for level3</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">  <span class="n">th_stage2_param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pipe_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">th_stage2_param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_stage2_password</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">th_stage2</span> <span class="o">=</span> <span class="n">create_stage2_thread</span><span class="p">(</span><span class="n">th_stage2_param</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">th_stage2</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">th_stage3_param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">int_1337</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">th_stage3_param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_stage3_password</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">th_stage3</span> <span class="o">=</span> <span class="n">create_stage3_thread</span><span class="p">(</span><span class="n">th_stage3_param</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">th_stage3</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
</span></span></code></pre></div><p>You can dig into the create_stageX_thread functions by yourself, i dont think there&rsquo;s anything worth mentioning.
Basically stage2 reads input from a named pipe, stage3 listen on 127.0.0.1:1337 to do the same.</p>
<p>The function that verifies the level 2 password received from the frontend is the one i renamed <code>check_stage2_password</code></p>
<h3 id="29-check_stage2_password---the-return-of-the-hashes">2.9 check_stage2_password() - the return of the hashes<a href="#29-check_stage2_password---the-return-of-the-hashes" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>This function starts by initializing a byte array:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF158955A</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xB5626D7C</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xD68AC6C2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10F6F220</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4CEF8FD8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8B4663D6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xA2BE0D1A</span><span class="p">;</span>
</span></span></code></pre></div><p>then removes the trailing spaces (including \r\n) of the input password and computes its hash using the same algorithm than for the anti analysis process check:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">  <span class="n">remove_trailing_spaces</span><span class="p">(</span><span class="o">&amp;</span><span class="n">password_from_pipe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v32</span><span class="p">,</span> <span class="n">v16</span><span class="p">,</span> <span class="n">v32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">a7</span> <span class="o">&lt;</span> <span class="mh">0x10</span> <span class="o">||</span> <span class="p">(</span><span class="n">password</span> <span class="o">=</span> <span class="n">password_from_pipe</span><span class="p">,</span> <span class="p">(</span><span class="n">v33</span> <span class="o">=</span> <span class="n">password_from_pipe</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">hash</span> <span class="o">=</span> <span class="mh">0xBADC0FFE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">password_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">password</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">n_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">password_len</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">do</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">password_char_lower</span> <span class="o">=</span> <span class="n">tolower</span><span class="p">(</span><span class="n">password</span><span class="p">[</span><span class="n">n_1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="n">password</span> <span class="o">=</span> <span class="n">v33</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">++</span><span class="n">n_1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">hash</span> <span class="o">=</span> <span class="n">password_char_lower</span> <span class="o">^</span> <span class="n">__ROL4__</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">while</span> <span class="p">(</span> <span class="n">n_1</span> <span class="o">&lt;</span> <span class="n">password_len</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><p>afterwards it checks if the hash exists in the global list of hashes that has been initialized earlier, and if it does, uses the input password to decrypt the byte array:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">  <span class="n">key</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">password_from_pipe</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">rc4_decrypt</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">,</span> <span class="n">crypted</span><span class="p">,</span> <span class="mh">0x1Du</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">some_chr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">crypted</span> <span class="o">+</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">some_chr</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">some_chr</span> <span class="o">&gt;=</span> <span class="sc">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="n">some_chr</span> <span class="o">!=</span> <span class="sc">&#39;\x7F&#39;</span> <span class="o">||</span> <span class="n">some_chr</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="o">||</span> <span class="n">some_chr</span> <span class="o">==</span> <span class="sc">&#39;\r&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">++</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">29</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">INVALID_PASSWORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><p>and checks that the result is more or less ascii printable</p>
<h5 id="note-the-decryption-algorithm-is-rc4">Note: The decryption algorithm is RC4.<a href="#note-the-decryption-algorithm-is-rc4" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h5>
<blockquote>
<p>RC4 is usually pretty easy to spot:</p>
<p>When you see a first loop initializing a 256 bytes array [0, 1, 2, &hellip;, 255], then a second loop with some permutations and 3rd loop with some XOR&rsquo;ing, you can be suspicious it&rsquo;s RC4: This <a href="https://en.wikipedia.org/wiki/RC4">Wikipedia page</a> shows it well.</p>
<p>In this case it turned out to be plain normal RC4.</p>
</blockquote>
<h3 id="210-finding-the-password">2.10 Finding the password<a href="#210-finding-the-password" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>At this point it&rsquo;s pretty clear that:</p>
<ul>
<li>the password needs to match one the hashes</li>
<li>the result of the RC4 decryption of the byte array with this password needs to be ascii printable</li>
</ul>
<p>So we just need to reverse the hashes and one of them must be the password ! right ?</p>
<p>With the help of Z3, this script will generate lowercase strings of a given length matching a given hash.
(PS: Z3 is great, use it and abuse it)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">z3</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">solve_hash</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">chr_lst</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="o">=</span> <span class="n">BitVec</span><span class="p">(</span><span class="s2">&#34;c</span><span class="si">%d</span><span class="s2">&#34;</span><span class="o">%</span><span class="n">x</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># lowercase letters + 3 2 6 4 _ -</span>
</span></span><span class="line"><span class="cl">                <span class="n">Or</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Or</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">51</span><span class="p">,</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">50</span><span class="p">,</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">54</span><span class="p">,</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">52</span><span class="p">,</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">95</span><span class="p">,</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">45</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">And</span><span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="mi">97</span><span class="p">,</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="mi">122</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">chr_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="n">BitVecVal</span><span class="p">(</span><span class="mh">0xbadc0ffe</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chr_lst</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span> <span class="o">=</span> <span class="n">RotateLeft</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">^</span> <span class="n">c</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1"># keep going while we have solutions</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span> <span class="o">==</span> <span class="n">sat</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">cond</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">pwd</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chr_lst</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">pwd</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">chr_lst</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span><span class="o">.</span><span class="n">as_long</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="n">cond</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chr_lst</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">chr_lst</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span><span class="o">.</span><span class="n">as_long</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># just dont print the same solution twice</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Or</span><span class="p">(</span><span class="n">cond</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">pwd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">:],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;hash = 0x</span><span class="si">%x</span><span class="s2">&#34;</span><span class="o">%</span><span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">solve_hash</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span></span></code></pre></div><p>While this works well for short strings, the number of collisions goes up exponentially and the method quickly reaches its limits:</p>
<pre tabindex="0"><code>% ./reverse_hash.py 0x5D9F9FD8 5
hash = 0x5d9f9fd8
% ./reverse_hash.py 0x5D9F9FD8 6
hash = 0x5d9f9fd8
x32dbg
zqrdbg
zs2dbg
% ./reverse_hash.py 0x5D9F9FD8 8 | wc -l
128
% ./reverse_hash.py 0x5D9F9FD8 9 | wc -l
17516
</code></pre><p>Notice that we found the hash for <code>x32dbg</code>.</p>
<p>So i tried it this way on short string lengths, also checked the hashes of the sysinternals tools and whatever analysis tool came to my mind, but i was still left with some unresolved hashes.</p>
<p>Until i put all the hashes i already had &ldquo;reversed&rdquo; together in a single google query and found this:
<a href="https://github.com/LordNoteworthy/al-khaser/blob/master/al-khaser/AntiAnalysis/process.cpp">https://github.com/LordNoteworthy/al-khaser/blob/master/al-khaser/AntiAnalysis/process.cpp</a></p>
<p>which turned to be the almost complete list of executable names matching the hashes.<br>
At this stage i had all but one hashes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xC81D63C9</span><span class="p">;</span>                 <span class="c1">// ollydbg
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5B2839AC</span><span class="p">;</span>                 <span class="c1">// processhacker
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x17DAD73F</span><span class="p">;</span>                 <span class="c1">// tcpview
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x72C7241C</span><span class="p">;</span>                 <span class="c1">// autoruns
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x58E483ED</span><span class="p">;</span>                 <span class="c1">// autorunsc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x82134662</span><span class="p">;</span>                 <span class="c1">// filemon
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x34204667</span><span class="p">;</span>                 <span class="c1">// procmon
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4CD53A71</span><span class="p">;</span>                 <span class="c1">// regmon
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x34206499</span><span class="p">;</span>                 <span class="c1">// procexp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFDEB191</span><span class="p">;</span>                 <span class="c1">// idaq
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7AC6410B</span><span class="p">;</span>                <span class="c1">// idaq64
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xEA3503AA</span><span class="p">;</span>                <span class="c1">// ImmunityDebugger
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xCCFA2924</span><span class="p">;</span>                <span class="c1">// wireshark
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3A09FFBC</span><span class="p">;</span>                <span class="c1">// dumpcap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x38EA0C1B</span><span class="p">;</span>                <span class="c1">// HookExplorer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x58E479EC</span><span class="p">;</span>                <span class="c1">// ImportREC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1B964E1A</span><span class="p">;</span>                <span class="c1">// petools
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x707F9D9A</span><span class="p">;</span>                <span class="c1">// lordpe
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF5A79701</span><span class="p">;</span>                <span class="c1">// SysInspector
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x9F5473B</span><span class="p">;</span>                 <span class="c1">// proc_analyzer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xBA635AC6</span><span class="p">;</span>                <span class="c1">// sysAnalyzer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xBB18A65</span><span class="p">;</span>                 <span class="c1">// sniff_hit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x46119FD8</span><span class="p">;</span>                <span class="c1">// windbg
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFB7BF6AF</span><span class="p">;</span>                <span class="c1">// joeboxcontrol
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3F75D54B</span><span class="p">;</span>                <span class="c1">// joeboxserver
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x49110E9F</span><span class="p">;</span>                <span class="c1">// ResourceHacker
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5D9F9FD8</span><span class="p">;</span>                <span class="c1">// x32dbg
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5DCC9FD8</span><span class="p">;</span>                <span class="c1">// x64dbg
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8293C33E</span><span class="p">;</span>                <span class="c1">// fiddler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5D112314</span><span class="p">;</span>                <span class="c1">// httpdebugger
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x9D9F8189</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">process_hash</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xC10AE786</span><span class="p">;</span>                <span class="c1">// pe-sieve
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x67D8B725</span><span class="p">;</span>                <span class="c1">// hollows_hunter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">process_hash</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7FE9020</span><span class="p">;</span>                 <span class="c1">// pin
</span></span></span></code></pre></div><p>I tried them all as input password: no luck.
I thought it would match the last hash i was missing, so i tried bruteforcing solutions&hellip; but it was just too long and probably not the correct path to the solution anyway.</p>
<p>Out of despair, i threw in a file whatever executable name i had and tried the RC4 decrypt:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">ARC4</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">printable_ascii</span> <span class="o">=</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">printable</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#import struct</span>
</span></span><span class="line"><span class="cl"><span class="c1">#crypt_v = [0xF158955A, 0xB5626D7C, 0xD68AC6C2, 0x10F6F220, 0x4CEF8FD8, 0x8B4663D6, 0xA2BE0D1A]</span>
</span></span><span class="line"><span class="cl"><span class="c1">#crypt = b&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#for v in crypt_v:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    crypt += struct.pack(&#39;&lt;I&#39;, v)</span>
</span></span><span class="line"><span class="cl"><span class="n">crypt</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;Z</span><span class="se">\x95</span><span class="s1">X</span><span class="se">\xf1</span><span class="s1">|mb</span><span class="se">\xb5\xc2\xc6\x8a\xd6</span><span class="s1"> </span><span class="se">\xf2\xf6\x10\xd8\x8f\xef</span><span class="s1">L</span><span class="se">\xd6</span><span class="s1">cF</span><span class="se">\x8b\x1a\r\xbe\xa2</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;executable_names.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fp</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">==</span>
</span></span><span class="line"><span class="cl">        <span class="n">cipher</span> <span class="o">=</span> <span class="n">ARC4</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">dec</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">crypt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">dec</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">printable_ascii</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
</span></span></code></pre></div><p>and ho surprise:</p>
<pre tabindex="0"><code>% python rc4_all_exe_names.py 
b&#39;ProcessHacker&#39;
b&#39;we_are_good_to_go_to_level3!&#39;
</code></pre><p>yeah&hellip; turned out the hashes are done on the lowercase password, but of course the RC4 key isn&rsquo;t key insensitive&hellip;</p>
<p><img src="facepalm.jpg" alt="facepal"></p>
<p>Anyway, we have the password for level2: <code>ProcessHacker</code></p>
<p><img src="32-l2-level_up.png" alt="level up"></p>
<h2 id="3-level-3">3. Level 3<a href="#3-level-3" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<h3 id="31-first-impression">3.1 First impression<a href="#31-first-impression" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>As earlier mentionned, level2.exe spins two threads:</p>
<ul>
<li>one dealing with the named pipe for level 2</li>
<li>one listening on localhost:1337 for level 3</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">  <span class="n">th_stage3_param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">int_1337</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">th_stage3_param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_stage3_password</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">th_stage3</span> <span class="o">=</span> <span class="n">create_stage3_thread</span><span class="p">(</span><span class="n">th_stage3_param</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">th_stage3</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
</span></span></code></pre></div><p>Let&rsquo;s examine the <code>check_stage3_password</code> function.</p>
<p>It starts off by initializing a byte array, similarly to level 2:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xA39BB17F</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x987AB8DB</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2F6BE93E</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5A40C4AC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5F900F42</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xAB9CF15C</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF51B7932</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x6A3CA0C</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4A4A45C4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x21591DF6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xC7F3DA41</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xA3EEEFBA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x45820D2D</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x34D33517</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xD7C3DCCB</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFA5E5BB3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x69E23F67</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">crypted</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5A4102EF</span><span class="p">;</span>
</span></span></code></pre></div><p>followed by a call to <code>CryptStringToBinaryA</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">  <span class="c1">// base 64 decode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">CryptStringToBinaryA</span><span class="p">(</span><span class="n">input_password</span><span class="p">,</span> <span class="n">cchString</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="n">decoded_base64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcbBinary</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdwFlags</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">NOPE</span><span class="p">;</span>
</span></span></code></pre></div><p><strong>Note</strong>: The 3rd parameter is 0x1, which means CRYPT_STRING_BASE64 / base64 without headers (ref: <a href="https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptstringtobinarya">Microsoft</a>)</p>
<p>Then, the decoded base64 is processed by a small loop, doing ROR/ROL based on the <em>Y cursor coordinate</em> and checking it against the <em>X cursor coordinate</em>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">pcbBinary</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">  	<span class="c1">// GetCursorPos - what ???
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span> <span class="n">GetCursorPos</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Point</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">point_y</span> <span class="o">=</span> <span class="n">Point</span><span class="p">.</span><span class="n">y</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">v10</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">decoded_base64</span><span class="p">[</span><span class="n">n</span> <span class="o">%</span> <span class="n">decStrLen</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">v11</span> <span class="o">=</span> <span class="o">*</span><span class="n">v10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">v12</span> <span class="o">=</span> <span class="o">*</span><span class="n">v10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">v13</span> <span class="o">=</span> <span class="o">*</span><span class="n">v10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">v14</span> <span class="o">=</span> <span class="o">*</span><span class="n">v10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>                       <span class="c1">// odd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">dec_byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">v13</span> <span class="o">&lt;&lt;</span> <span class="n">point_y</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">v12</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">point_y</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">v15</span> <span class="o">=</span> <span class="n">v14</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">point_y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">v16</span> <span class="o">=</span> <span class="n">v11</span> <span class="o">&gt;&gt;</span> <span class="n">point_y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span>                                      <span class="c1">// even
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">dec_byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">v13</span> <span class="o">&gt;&gt;</span> <span class="n">point_y</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">v12</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">point_y</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">v15</span> <span class="o">=</span> <span class="n">v14</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">point_y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">v16</span> <span class="o">=</span> <span class="n">v11</span> <span class="o">&lt;&lt;</span> <span class="n">point_y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// we want this to be TRUE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">v16</span> <span class="o">|</span> <span class="n">v15</span><span class="p">)</span> <span class="o">==</span> <span class="n">LOBYTE</span><span class="p">(</span><span class="n">Point</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">decoded_base64</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">dec_byte</span><span class="p">;</span>			<span class="c1">// replace the byte in place in the string
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">      <span class="c1">// we sure need some sleep...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">Sleep</span><span class="p">(</span><span class="mh">0x1Eu</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="n">decStrLen</span> <span class="o">=</span> <span class="n">strlen_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="o">++</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">strlen_size</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">CHECK_CHAR_SET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">NOPE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><p>after this wizardry, we&rsquo;re supposed to be left with a more or less ascii printable string:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">chr</span> <span class="o">=</span> <span class="n">decoded_base64</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">chr</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">chr</span> <span class="o">&gt;=</span> <span class="sc">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="n">chr</span> <span class="o">!=</span> <span class="mi">127</span> <span class="o">||</span> <span class="n">chr</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="o">||</span> <span class="n">chr</span> <span class="o">==</span> <span class="sc">&#39;\r&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">++</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0xFF</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">NOPE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><p>which will serve (again !) as a RC4 key, which should decrypt the byterarray to something more or less ascii printable</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">  <span class="n">rc4_decrypt</span><span class="p">(</span><span class="n">decoded_base64</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">crypted</span><span class="p">,</span> <span class="mh">0x48u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_chr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">crypted</span> <span class="o">+</span> <span class="n">j</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">_chr</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">_chr</span> <span class="o">&gt;=</span> <span class="sc">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="n">_chr</span> <span class="o">!=</span> <span class="mi">127</span> <span class="o">||</span> <span class="n">_chr</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="o">||</span> <span class="n">_chr</span> <span class="o">==</span> <span class="sc">&#39;\r&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">++</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mh">0x48</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">NONO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><p>Easy game ! Except that <code>GetCursorPos()</code> call in the loop right after the base64 decode&hellip;
Are we supposed to guess the password <strong><em>while having the mouse cursor positionned correctly on screen at each loop</em></strong> ?</p>
<p>I don&rsquo;t think so (or rather i hope not), so let&rsquo;s go back a bit&hellip;</p>
<h3 id="32-back-to-stage-2-more-unpacking">3.2 Back to stage 2 (more unpacking)<a href="#32-back-to-stage-2-more-unpacking" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>If we remember correctly, once the 2nd password is correctly entered, the crackme decrypts a dot NET assembly.
Let&rsquo;s extract it.</p>
<p>We can use dnSpy to dynamically debug the crackme (the crackme is 32 bits so make sure to use the 32 bits version of dnSpy for this task).
In order to do it at the correct moment, we need to close the crackme, open it again and enter the 1st password.</p>
<p>Then, attach the process in dnSpy:</p>
<p><img src="40-l3-attach.png" alt="attach process"></p>
<p>Navigate to the <code>LoadNext.Load</code> method, then click on <code>Assembly.Load</code></p>
<p><img src="41-l3-assembly.load.png" alt="loadnext"></p>
<p>this will automagically take us where we want to set a breakpoint (by pressing F9)</p>
<p><img src="41-l3-breakpoint.png" alt="breakpoint"></p>
<p>Now we can enter the level 2 password and after clicking the &ldquo;level up&rdquo; popup, the breakpoint will be hit.
Right click the <code>rawAssembly</code> local variable and <code>Save...</code> it to file.</p>
<p><img src="43-l3-save_assembly.png" alt="save to file"></p>
<h3 id="33-matryoshka-and-more-unpacking">3.3 Matryoshka (and more unpacking)<a href="#33-matryoshka-and-more-unpacking" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>Since we&rsquo;re supposed to have unpacked a Dot NET assembly, we can load the new file straight into dnSpy
We find our friends <code>Level3Bin.Class1</code> and <code>RunMe</code> that we&rsquo;ve seen when following the code handling the click on the level 2 button, inside <code>LoadNext.Load()</code>.</p>
<p><img src="44-l3-runme.png" alt="runme"></p>
<p>along with a promising <code>DropTheDll</code> method and <code>DllInj</code> class.</p>
<p><code>RunMe</code> will create a temp file, write the DLL to it and inject it into the running level2.exe.</p>
<p>There&rsquo;s different ways of gettting this DLL:</p>
<ul>
<li>since the DLL is just base64 encoded in the DropTheDll method, we can also just copy this string and do the base64 decode..</li>
<li>we could also attach a debugger to level2.exe, making sure to break on DLL Load, get the path and copy the file (<code>&quot;C:\\Users\\matth\\AppData\\Local\\Temp\\4x4bdt1g.dat&quot;</code> in this case)</li>
</ul>
<p><img src="45-l3-dll_path.png" alt="dllpath"></p>
<pre tabindex="0"><code>C:\Users\matth\Desktop\MalwareBytes&gt;copy C:\Users\matth\AppData\Local\Temp\4x4bdt1g.dat level3_unpacked.dll
        1 file(s) copied.
</code></pre><p>at least we have it now.</p>
<p>The injection code looks pretty standard and is done by the book: you can even find this method on <a href="https://en.wikipedia.org/wiki/DLL_injection#Using_the_LoadLibrary_API_function">Wikipedia</a> :)</p>
<p><img src="46-l3_injection.png" alt="Injection"></p>
<h3 id="34-hooks">3.4 Hooks<a href="#34-hooks" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>Opening the newly acquired DLL and navigating to DllMain(), the author was kind enough to tell us what is going to happen: hooking !</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">BOOL</span> <span class="kr">__stdcall</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HINSTANCE</span> <span class="n">hinstDLL</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">fdwReason</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpvReserved</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">HANDLE</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">HANDLE</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">fdwReason</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">fdwReason</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">OutputDebugStringA</span><span class="p">(</span><span class="s">&#34;Hooking the process&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">sub_10004D00</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">v3</span> <span class="o">=</span> <span class="n">GetCurrentThread</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">sub_10005260</span><span class="p">(</span><span class="n">v3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">sub_10004570</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dword_1002AE60</span><span class="p">,</span> <span class="n">sub_10002990</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">sub_10004570</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dword_1002AE64</span><span class="p">,</span> <span class="n">sub_10002B10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">sub_10004570</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dword_1002AE68</span><span class="p">,</span> <span class="n">sub_10002B60</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">sub_10004D60</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">OutputDebugStringA</span><span class="p">(</span><span class="s">&#34;Unhooking the process&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub_10004D00</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">v5</span> <span class="o">=</span> <span class="n">GetCurrentThread</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub_10005260</span><span class="p">(</span><span class="n">v5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub_10004A10</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dword_1002AE60</span><span class="p">,</span> <span class="n">sub_10002990</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub_10004A10</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dword_1002AE64</span><span class="p">,</span> <span class="n">sub_10002B10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub_10004A10</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dword_1002AE68</span><span class="p">,</span> <span class="n">sub_10002B60</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub_10004D60</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>At first glance, the DLL is hooking 3 functions, but which ones ?</p>
<p>An easy way to figure this out, is to configure x64dbg to break on DLL Entry, <em>before entering the 2nd password</em>.
When we&rsquo;ll enter the 2nd password, the dll will be injected and run, and the breakpoint will trigger.</p>
<p><img src="48-dll_entry.jpg" alt="break on entry"></p>
<p>From there, navigate to the piece of code performing the hooking and break before it&rsquo;s executed:</p>
<p><img src="47-hooking_the_process.jpg" alt="Hooking the process"></p>
<p>The hooks are revealed:</p>
<p><img src="49-hooks.jpg" alt="hooks revealed"></p>
<ul>
<li>1st hook replaces <code>CryptStringToBinaryA</code></li>
<li>2nd hook replaces <code>GetCursorPos</code></li>
<li>3rd hook replaces <code>_SleepStub</code></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">      <span class="n">OutputDebugStringA</span><span class="p">(</span><span class="s">&#34;Hooking the process&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">sub_10004D00</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="kr">thread</span> <span class="o">=</span> <span class="n">GetCurrentThread</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">sub_10005260</span><span class="p">(</span><span class="kr">thread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">hook</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">g_trampoline_CryptStringToBinaryA</span><span class="p">,</span> <span class="n">hook_CryptStringToBinaryA</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">hook</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">g_trampoline_GetCursorPos</span><span class="p">,</span>         <span class="n">hook_GetCursorPos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">hook</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">g_trampoline_SleepStub</span><span class="p">,</span>            <span class="n">hook_SleepSub</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">sub_10004D60</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span></code></pre></div><p>After the hooking, all calls to these 3 functions will be redirected to the new hook_* functions.
This seems to be done by modifying the code in memory rather than by modifying the IAT (Import Address Table)</p>
<p>After the new hook execution, the control flow is not transfered back to the original function, so the hook actually <em>replaces</em> the original function.</p>
<p>This is what <code>GetCursorPos</code> looks like before hooking (we&rsquo;re in user32.dll)</p>
<p><img src="51-iat_hook_getcursorpos_1.jpg" alt="before hooking"></p>
<p>And this is what it looks like after hooking:</p>
<p><img src="51-iat_hook_getcursorpos_2_after_hooking.jpg" alt="after hooking"></p>
<p>The prologue has been replaced by a jump to some code in the injected DLL, precisely to the &ldquo;new&rdquo; GetCursorPos<br>
Here below listing for easy comparison:</p>
<p><img src="52-getcursorpos_assembly.jpg" alt="new GetCursorPos"></p>
<h5 id="note"><em>Note:</em><a href="#note" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h5>
<p>In the hooked <code>CryptStringToBinaryA</code> there&rsquo;s a call to the actual CryptStringToBinaryA function to perform the base64 decode, this is done using a trampoline:</p>
<p>the instructions (bytes) overwritten by the hook jump are saved when the hook is setup (<code>&amp;g_trampoline_CryptStringToBinaryA</code>), followed by a jump back to the original code, right after the overwrite.</p>
<p>Calling the trampoline executes the original, pre-hooking, code.</p>
<p><img src="53-trampoline.png" alt="Trampoline"></p>
<p>I&rsquo;m no expert but the hooking seems to be done using <a href="https://github.com/microsoft/Detours">Detours</a>.<br>
<em>More info on hooking by Jurriaan Bremer: <a href="http://jbremer.org/x86-api-hooking-demystified/">x86 API Hooking Demystified</a></em></p>
<p>Now let&rsquo;s look the 3 hooks.</p>
<h4 id="341-sleep">3.4.1 Sleep<a href="#341-sleep" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>Sleep will just increment a global variable</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="kr">__stdcall</span> <span class="nf">hook_SleepSub</span><span class="p">(</span><span class="kt">int</span> <span class="n">a1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">++</span><span class="n">g_IncrementedByEachSleep</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="341-cryptstringtobinarya">3.4.1 CryptStringToBinaryA<a href="#341-cryptstringtobinarya" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>CryptStringToBinaryA will actually perform normally, with the addition that it is initializing <code>g_IncrementedByEachSleep</code> to 4</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">  <span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// calling the real CryptStringToBinaryA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">v10</span> <span class="o">=</span> <span class="n">g_trampoline_CryptStringToBinaryA</span><span class="p">(</span><span class="n">pszString</span><span class="p">,</span> <span class="n">cchString</span><span class="p">,</span> <span class="n">dwFlags</span><span class="p">,</span> <span class="n">pbBinary</span><span class="p">,</span> <span class="n">pcbBinary</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// setting global counter to 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span> <span class="n">v10</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">counter</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">g_IncrementedByEachSleep</span> <span class="o">=</span> <span class="n">counter</span><span class="p">;</span>
</span></span></code></pre></div><h4 id="341-getcursorpos">3.4.1 GetCursorPos<a href="#341-getcursorpos" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>GetCursorPos will use the global counter to return (x, y) position values from 2 arrays, instead of the actual cursor position.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__stdcall</span> <span class="nf">hook_GetCursorPos</span><span class="p">(</span><span class="n">POINT</span> <span class="o">*</span><span class="n">point</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">point</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="n">g_Y_cursor_pos</span><span class="p">[</span><span class="n">g_IncrementedByEachSleep</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">point</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="n">g_X_cursor_pos</span><span class="p">[</span><span class="n">g_IncrementedByEachSleep</span> <span class="o">%</span> <span class="mh">0x21</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>with:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">g_Y_cursor_pos</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x48</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">g_X_cursor_pos</span>  <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xad</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x9c</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><p>We do not have to guess the cursor positions anymore!</p>
<h3 id="35-the-final-password">3.5 The final password<a href="#35-the-final-password" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>With these new information, the routine we&rsquo;ve stumbled upon earlier makes much more sense:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// do actual base64 decoding but also
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// initialize a counter to 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">CryptStringToBinaryA</span><span class="p">(</span><span class="n">input_password</span><span class="p">,</span> <span class="n">cchString</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="n">decoded_base64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcbBinary</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdwFlags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// with the hook it now returns (x, y) position from 2 known arrays
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span> <span class="n">GetCursorPos</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Point</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">point_y</span> <span class="o">=</span> <span class="n">Point</span><span class="p">.</span><span class="n">y</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">v10</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">decoded_base64</span><span class="p">[</span><span class="n">n</span> <span class="o">%</span> <span class="n">decStrLen</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">v11</span> <span class="o">=</span> <span class="o">*</span><span class="n">v10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">v12</span> <span class="o">=</span> <span class="o">*</span><span class="n">v10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">v13</span> <span class="o">=</span> <span class="o">*</span><span class="n">v10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">v14</span> <span class="o">=</span> <span class="o">*</span><span class="n">v10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>                       <span class="c1">// odd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">dec_byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">v13</span> <span class="o">&lt;&lt;</span> <span class="n">point_y</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">v12</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">point_y</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">v15</span> <span class="o">=</span> <span class="n">v14</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">point_y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">v16</span> <span class="o">=</span> <span class="n">v11</span> <span class="o">&gt;&gt;</span> <span class="n">point_y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span>                                      <span class="c1">// even
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">dec_byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">v13</span> <span class="o">&gt;&gt;</span> <span class="n">point_y</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">v12</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">point_y</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">v15</span> <span class="o">=</span> <span class="n">v14</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">point_y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">v16</span> <span class="o">=</span> <span class="n">v11</span> <span class="o">&lt;&lt;</span> <span class="n">point_y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// we want this to be TRUE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">v16</span> <span class="o">|</span> <span class="n">v15</span><span class="p">)</span> <span class="o">==</span> <span class="n">LOBYTE</span><span class="p">(</span><span class="n">Point</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">decoded_base64</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">dec_byte</span><span class="p">;</span>			<span class="c1">// replace the byte in place in the string
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">      <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// increment a counter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">Sleep</span><span class="p">(</span><span class="mh">0x1Eu</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="n">decStrLen</span> <span class="o">=</span> <span class="n">strlen_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="o">++</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">strlen_size</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">CHECK_CHAR_SET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">NOPE</span><span class="p">;</span>
</span></span></code></pre></div><p>we can put everything together in a final script.</p>
<ul>
<li>(Ab)use Z3 to figure the correct input</li>
<li>use these input to get the key</li>
<li>use the key to get the flag</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">z3</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">ARC4</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">struct</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># crypted string</span>
</span></span><span class="line"><span class="cl"><span class="n">crypted_dw</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x0A39BB17F</span><span class="p">,</span> <span class="mh">0x987AB8DB</span><span class="p">,</span> <span class="mh">0x2F6BE93E</span><span class="p">,</span> <span class="mh">0x5A40C4AC</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x5F900F42</span><span class="p">,</span> <span class="mh">0x0AB9CF15C</span><span class="p">,</span> <span class="mh">0x0F51B7932</span><span class="p">,</span> <span class="mh">0x6A3CA0C</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x4A4A45C4</span><span class="p">,</span> <span class="mh">0x21591DF6</span><span class="p">,</span> <span class="mh">0x0C7F3DA41</span><span class="p">,</span> <span class="mh">0x0A3EEEFBA</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x45820D2D</span><span class="p">,</span> <span class="mh">0x34D33517</span><span class="p">,</span> <span class="mh">0x0D7C3DCCB</span><span class="p">,</span> <span class="mh">0x0FA5E5BB3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x69E23F67</span><span class="p">,</span> <span class="mh">0x5A4102EF</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># just build a bytes string from from the above dwords</span>
</span></span><span class="line"><span class="cl"><span class="n">crypted</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">crypted_dw</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">crypted</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># (x, y) positions from the dll</span>
</span></span><span class="line"><span class="cl"><span class="n">y_positions</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x48</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">x_positions</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xad</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x9c</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">GetCursorPos</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39; emulate hooked GetCursorPos
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">y_positions</span><span class="p">[</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="n">x_positions</span><span class="p">[</span><span class="n">c</span> <span class="o">%</span> <span class="mh">0x21</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># abuse z3 to find a valid input</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">size</span> <span class="o">=</span> <span class="mi">33</span>   <span class="c1"># size of the input key // 0x21 .. size of x_positions array</span>
</span></span><span class="line"><span class="cl"><span class="n">inp</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># create input and output BitVec</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the output are just to get the key straight away</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">inp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BitVec</span><span class="p">(</span><span class="s1">&#39;i</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">x</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BitVec</span><span class="p">(</span><span class="s1">&#39;o</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">x</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># initialize the global counter</span>
</span></span><span class="line"><span class="cl"><span class="n">counter</span> <span class="o">=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># run the little routine with GetCursorPos</span>
</span></span><span class="line"><span class="cl"><span class="c1"># it&#39;s just ROL/ROR</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inp</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">GetCursorPos</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">&amp;</span> <span class="mi">7</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">pos</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dec_byte</span> <span class="o">=</span> <span class="n">RotateRight</span><span class="p">(</span><span class="n">inp</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">check</span> <span class="o">=</span>    <span class="n">RotateLeft</span><span class="p">(</span><span class="n">inp</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dec_byte</span> <span class="o">=</span> <span class="n">RotateLeft</span><span class="p">(</span><span class="n">inp</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">check</span> <span class="o">=</span>    <span class="n">RotateRight</span><span class="p">(</span><span class="n">inp</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># the actual constrain we want to fullfil</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># if ( (v16 | v15) == LOBYTE(Point.x) )</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">check</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># (dirty?) trick to get the output value straight away</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="n">dec_byte</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Sleep()</span>
</span></span><span class="line"><span class="cl">    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># hopefully will not happen</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span> <span class="o">!=</span> <span class="n">sat</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">raise</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># we found a valid input</span>
</span></span><span class="line"><span class="cl"><span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pwd</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">key</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># get input (password) and output (key) values from the model</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inp</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="n">pwd</span> <span class="o">+=</span> <span class="n">m</span><span class="p">[</span><span class="n">inp</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span><span class="o">.</span><span class="n">as_long</span><span class="p">()</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">out</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span><span class="o">.</span><span class="n">as_long</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;password: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">pwd</span><span class="p">),</span> <span class="s1">&#39;ascii&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;key     : </span><span class="si">%s</span><span class="s2">&#34;</span><span class="o">%</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># get flag</span>
</span></span><span class="line"><span class="cl"><span class="n">cipher</span> <span class="o">=</span> <span class="n">ARC4</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;ascii&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">crypted</span><span class="p">),</span> <span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;flag    : </span><span class="si">%s</span><span class="s2">&#34;</span><span class="o">%</span><span class="n">flag</span><span class="p">)</span>
</span></span></code></pre></div><p>Running the script yields this output:</p>
<pre tabindex="0"><code>% python l3.py 
password: ua2wsWz1aPZvbZv1bbBbZV+wryaW7PqMpcxmZZOs3GOy
key     : small_hooks_make_a_big_difference
flag    : flag{you_got_this_best_of_luck_in_reversing_and_beware_of_red_herrings}
</code></pre><p><img src="60-win.jpg" alt="win"></p>
<h2 id="6-references">6. References<a href="#6-references" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>Dynamic API functions address resolution:</p>
<ul>
<li><a href="https://0xevilc0de.com/locating-dll-name-from-the-process-environment-block-peb/">https://0xevilc0de.com/locating-dll-name-from-the-process-environment-block-peb/</a></li>
<li><a href="https://www.ired.team/offensive-security/code-injection-process-injection/finding-kernel32-base-and-function-addresses-in-shellcode">https://www.ired.team/offensive-security/code-injection-process-injection/finding-kernel32-base-and-function-addresses-in-shellcode</a></li>
</ul>
<p>Tools for dealing with hashes:</p>
<ul>
<li><a href="https://github.com/mandiant/flare-ida">https://github.com/mandiant/flare-ida</a></li>
<li><a href="https://github.com/OALabs/hashdb">https://github.com/OALabs/hashdb</a></li>
</ul>
<p>PE to shellcode:</p>
<ul>
<li><a href="https://github.com/hasherezade/pe_to_shellcode">https://github.com/hasherezade/pe_to_shellcode</a></li>
<li><a href="https://github.com/stephenfewer/ReflectiveDLLInjection">https://github.com/stephenfewer/ReflectiveDLLInjection</a></li>
</ul>
<p>Anti Debug:</p>
<ul>
<li><a href="https://github.com/hasherezade/antianalysis_demos/blob/master/kernelmode_antidbg.cpp">https://github.com/hasherezade/antianalysis_demos/blob/master/kernelmode_antidbg.cpp</a></li>
<li><a href="https://anti-reversing.com/Downloads/Anti-Reversing/The_Ultimate_Anti-Reversing_Reference.pdf">https://anti-reversing.com/Downloads/Anti-Reversing/The_Ultimate_Anti-Reversing_Reference.pdf</a></li>
</ul>
<p>RC4:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/RC4">https://en.wikipedia.org/wiki/RC4</a></li>
</ul>
<p>Code Injection:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/DLL_injection#Using_the_LoadLibrary_API_function">https://en.wikipedia.org/wiki/DLL_injection#Using_the_LoadLibrary_API_function</a></li>
</ul>
<p>Hooking:</p>
<ul>
<li><a href="https://github.com/microsoft/Detours">https://github.com/microsoft/Detours</a></li>
<li><a href="http://jbremer.org/x86-api-hooking-demystified/">http://jbremer.org/x86-api-hooking-demystified/</a></li>
<li><a href="https://www.ired.team/offensive-security/code-injection-process-injection/import-adress-table-iat-hooking">https://www.ired.team/offensive-security/code-injection-process-injection/import-adress-table-iat-hooking</a></li>
</ul>
<h2 id="5-conclusion">5. Conclusion<a href="#5-conclusion" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>It was very enjoyable, even though i was stuck way too long on level2, because of something silly.
There&rsquo;s a lot of manual unpacking described here, but that was my intention (not just fire some tool and forget).</p>
<p>I hope this writeup does not contain too many mistakes: should you spot anything incorrect, feel free to <a href="https://twitter.com/matth_walter">contact me</a>.</p>
<p>Thank you for reading.</p>

			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://matth.dmz42.org/tags/reverse">reverse</a></span><span class="tag"><a href="https://matth.dmz42.org/tags/malware">malware</a></span><span class="tag"><a href="https://matth.dmz42.org/tags/crackme">crackme</a></span><span class="tag"><a href="https://matth.dmz42.org/tags/writeup">writeup</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>6267 Words</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2021-11-08 14:20 &#43;0100</p>
			</footer>
		</article>
		<div class="post-nav thin">
			<a class="next-post" href="https://matth.dmz42.org/posts/2022/reversing-firmwares-from-fs-and-bdcom-switches/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;Newer</span><br><span>Reversing Firmwares from FS and BDCOM Switches</span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2023 <a href="https://matth.dmz42.org">Matthieu Walter</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://matth.dmz42.org/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>



	<script src="https://matth.dmz42.org/js/bundle.min.580988ed2982bcbb74a1773c7abea97b43e4c43b9324e10cda0813ec6ec4bb67.js" integrity="sha256-WAmI7SmCvLt0oXc8er6pe0PkxDuTJOEM2ggT7G7Eu2c=" crossorigin="anonymous"></script>
	

</body>

</html>
